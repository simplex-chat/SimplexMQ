# SMP agent groups

## Problems

- device/user profile synchronisation
- group communication

Both use cases can be facilitated by message broadcast between a group of SMP agents.

## Solution: symmetric groups as part of SMP agent protocol

The proposed approach does not scale to large groups, as each agent has to broadcast the messages of their clients to all other agents in the group. While for large group it is more effective to have a server managing the list of group members, it introduces the challenges with key distribution, privacy etc.

This proposal contains the set of additional SMP agent commands and message envelopes to provide a low level abstraction for group communication.

The groups are symmetric, all agents who are members of the group have equal rights and can add and remove members and leave group.

All the information about the groups is stored only in the agents.

As these groups are intended to be small and consist of users who sufficiently trust each other, and for simplicity, the initial protocol version assumes that any group member can add and remove users, and these actions will be replicated by other agents without asking user approval up to a certain number of users, after which an approval can be asked.

## Group message integrity

Two approaches are possible:

1. Each agent on a regular interval sends to all agents the sender IDs and the digests of the last messages from all agents they communicate with.
To avoid `(n-1)*n` messages for each group integrity verification, IDs and digests from all senders can be compacted in one messages:

```
broadcast: %s"G_CHECK" SP memId1 ":" msgId1 ":" hash1 ":" status1 "," memId2 ":" msgId2 ":" hash2 ":" status2
```

A side question is that we currently do not support large agent messages; possibly we should support messages larger than SMP block size to simplify this and other scenarios, similarly to how websockets protocol does it. There might still be a limit to how large the full message can be. That probably requires re-thinking of how messages are managed and separation of message reception from the servers and message delivery to the clients, but this might be required anyway for when we start running the agent in the background.

The above approach requires a way to identify all members by all members to all members, but such tripartite IDs are generated when adding the new members to the group (e.g. `gidABM` in the sequence diagram).

There may be two situations to consider:

1) The recipient of this verification message can have the same message as the last one or they can have more messages received - both such scenarios are ok and do not necessarily receive a problem, as they just might be slightly ahead in receiving the messages. They would make the last matching message as ok, and the later would remain unknown - it does not indicate the lack of integrity of the group, although if the next integrity check without the same messages does (this needs to be clarified).
2) The recipient of this verification message can have fewer messages received. This situation can be resolved in several ways:
- try to retrieve all messages from the queue that is behind. It might work, but it may be that the sender is simply trying to send messages because the network is down.
- wait until the next integrity check and only report integrity violation if during the next integrity check they still cannot reconcile the previous integrity check. This is probably an acceptable compromise.

2. Each agent sends message receipts to sending agents - message receipts would contain a signature of the message hashes. In the agent uses the same verification key for each member of the group, as considered below, these receipts can be re-broadcasted to other agents (again, grouping them in one message to avoid `(n-1)*n` messages) as a proof that the messages were delivered.

Comparing with the first approach, there are pros and cons:
- pros:
  - the sender would only send such integrity check messages when they have send a message to all parties, thus avoiding the situation when some messages might have been not yet sent (or failed to send and they are retrying).
- cons:
  - integrity check message mush contain a signature per member, so it would be substantially larger.
  - agents must use the same verification key for all members in the group, complicating the group and connections management.

Overall the first approach seems better. It shows who received which messages and the only case where the lack of integrity would be reported if the same message is different or some messages are skipped to some recipients (i.e. they broadcast integrity violation for some of the senders).

## Agent commands and messages syntax

- command `G:gId? NEW gInfo` - create group (response is `G:gId OK`)
- command `C:cAlias INTRO G:gId gInfo` - invite existing connection to a group
- message `C:cAlias REQ g:invID gInfo` - invitation to join the group
- command `G:gId? JOIN g:invId` - accept invitation (response is `G:gId OK`)
- message `G:gId CON cAlias` - 2 connections created with some group member (both for group and direct messages)
- message `G:gId MEM [C:cAlias]` - connection created with all group members for a given member or current client
- command `G:gId SEND msg` - send message to group
- message `G:gId SENT C:cAlias msgId` - notification that the message is sent and its internal ID, same as SENT
- message `G:gId MSG C:cAlias msgdata` - received group message from cAlias, msgdata is the same set of parameters as in `MSG`
- command `G:gId ACK msgId` - acknowledge message reception by the client
- message `G:gId RCVD C:cAlias msgId status` - message delivery notification
- command `G:gId LEAVE` - leave the group
- message `G:gId LEFT [cAlias]` - connection cAlias left the group
- command `G:gId REM cAlias` - remove group member (response is `G:gId OK`, followed by `REMD` notification)
- message `G:gId REMD cAlias [cAlias]` - member removed (who, by whom)
- message `G:gId OUT cAlias` - you are removed
- message `G:gId EMPTY` - all members left the group and it is now empty
- command `G:gId DEL` - delete the group (response is `G:gId OK`)
- message `G:gId DELD [cAlias]` - group deleted
- TODO changing member roles

## Agent message envelopes syntax (group-specific)

- `GROUP mid g:inv gInfo` - invitation to join the group
- `MEM mid` - confirmation that member connected to all members
- `LEFT` - notification that member left the group
- `OUT` - you are removed from the group
- `REM mid` - remove member mid from the group
- `REMD mid` - confirmation that member is removed
- `DEL` - group is deleted
- `DELD` - confirmation that group is deleted

## Protocol costs

- Adding a member:
  - GROUP - 1
  - introductions - (4 + connection costs) * (n - 1)
  - MEM - (n - 1)
  - total - `6n-4` messages (reduced to `4n-2` with open invitations).

- Sending a message:
  - MSG - (n-1)
  - RCVD - (n-1)
  - total - `2n-2` messages

- Member leaves a group:
  - LEFT - (n-1)
  - total -`n-1` messages

- Member is removed by another member:
  - OUT - 1
  - REM - (n-1)
  - REMD - (n-1)
  - total `2n-1` messages

- Group is deleted:
  - DEL - (n-1)
  - DELD - (n-1)
  - total - `2n-2` messages

- Group integrity verification:
  - TODO

## Questions

1. Message verification keys. Agents use separate server and encryption key for each connection, but there can be a value of having the same message verification key used for all members in the group. E.g., a member can validate to other group members that the message was delivered to all group members by sending signed message receipts they receive from the agent. This would mean that for each message `n*(n-1)` messages will be send, although signed receipts can be grouped to reduce this number. It can be done periodically, rather than on each message, as described [here](https://signal.org/blog/private-groups/).

The [sequence digram for group operations](https://mermaid-js.github.io/mermaid-live-editor/#/view/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gIHBhcnRpY2lwYW50IE0gYXMgRXhpc3Rpbmc8YnI-bWVtYmVyIChNKVxuICBwYXJ0aWNpcGFudCBNQSBhcyBFeGlzdGluZzxicj5tZW1iZXI8YnI-YWdlbnQgKE1BKVxuICBwYXJ0aWNpcGFudCBBIGFzIEFsaWNlIChBKVxuICBwYXJ0aWNpcGFudCBBQSBhcyBBbGljZSdzPGJyPmFnZW50IChBQSlcbiAgcGFydGljaXBhbnQgQkEgYXMgQm9iJ3M8YnI-YWdlbnQgKEJBKVxuICBwYXJ0aWNpcGFudCBCIGFzIEJvYiAoQilcblxuICBub3RlIG92ZXIgQSwgQUE6IDEuIGNyZWF0ZSBuZXcgZ3JvdXAgKG5vIG1lbWJlcnMpXG4gIEEgLT4-IEFBOiBHOmdpZEE_IE5FVzxicj4oZ2lkQSAtIGNvbm4gYWxpYXMgb2YgdGhpcyBncm91cCBmb3IgQSw8YnI-Y2FuIGJlIGdlbmVyYXRlZCBieSB0aGUgYWdlbnQuPGJyPkRvZXMgaXQgc2hhcmUgbmFtZXNwYWNlIHdpdGggY29ubmVjdGlvbnM_KVxuXG4gIG5vdGUgb3ZlciBBQTogY3JlYXRlIFwiaW50ZXJuYWxcIiBicm9hZGNhc3QgYXNzb2NpYXRlZCB3aXRoIHRoZSBncm91cDxicj4oQjogTkVXKVxuXG4gIEFBIC0-PiBBOiBHOmdpZEEgT0tcblxuICBub3RlIG92ZXIgQSwgQkE6IDIuIGFkZCBCb2IgdG8gZ3JvdXBcblxuICBBIC0-PiBBQTogQzppZEFCIElOVFJPIEc6Z2lkQSBnSW5mbzxicj4oaWRBQiAtIGNvbm4gYWxpYXMgQSBoYXMgZm9yIEIpXG4gIFxuICBub3RlIG92ZXIgQUE6IGdlbmVyYXRlIG5ldyByYW5kb20gSUQgZm9yIG1lbWJlciBCIChtaWRCLCB1bmlxdWUgcGVyIGdyb3VwKTxicj5pbml0aWF0ZSBcImludGVybmFsXCIgY29ubmVjdGlvbiBnaWRBQiBmb3IgQiBpbiBncm91cDxicj4oaW50ZXJuYWwgbWVhbnMgdGhhdCBpdCBpcyBub3QgdmlzaWJsZSB0byB0aGUgY2xpZW50czxicj5hbmQgY2Fubm90IGJlIHVzZWQgd2l0aCBjbGllbnQgY29tbWFuZHMpXG5cbiAgQUEgLT4-IEJBOiB2aWEgaWRBQjogR1JPVVAgbWlkQiBnaWRBQmludiBnSW5mb1xuICBCQSAtPj4gQjogQzppZEJBIFJFUSBnOmludklEIGdJbmZvPGJyPihpbnZJRCAtIHRvIHJlZmVyIHRvIGl0IGluIEFDUFQpXG4gIEIgLT4-IEJBOiBHOmdpZEI_IEFDUFQgZzppbnZJRDxicj4oY291bGQgYmUgYWxzbyBSSkNUIGludklEPylcblxuICBub3RlIG92ZXIgQkE6IGNyZWF0ZSBncm91cCBhbmQgXCJpbnRlcm5hbFwiIGJyb2FkY2FzdCBhc3NvY2lhdGVkIHdpdGggdGhlIGdyb3VwPGJyPihCOiBORVcpXG5cbiAgQkEgLT4-IEI6IEc6Z2lkQiBPS1xuXG4gIEJBIC0-PiBBQTogZXN0YWJsaXNoIGludGVybmFsIGNvbm5lY3Rpb24gZ2lkQkEgKHVzaW5nIGdpZEFCaW52KSBmb3IgQSBpbiBncm91cFxuXG4gIG5vdGUgb3ZlciBCQSwgQUE6IGFkZCBjb25uZWN0aW9ucyBnaWRCQSBhbmQgZ2lkQUIgdG8gYnJvYWRjYXN0czxicj4oQjogQUREKVxuIFxuICBBQSAtPj4gQTogRzpnaWRBIENPTiBpZEFCXG4gIEJBIC0-PiBCOiBHOmdpZEEgQ09OIGlkQkFcblxuICBub3RlIG92ZXIgTSwgQjogRm9yIGVhY2ggZXhpc3RpbmcgbWVtYmVyIE06PGJyPmNyZWF0ZSBhbmQgYWNjZXB0IGludGVybmFsIGludHJvZHVjdGlvbiBiZXR3ZWVuIGNvbm5lY3Rpb25zLCByZWxhdGVkIHRvIHRoZSBncm91cCwgdmlhIGdpZEFCL0JBL0FNL01BLCBjb25uZWN0aW9ucyBjcmVhdGVkIGFyZSBnaWRCTSBhbmQgZ2lkTUI8YnI-VGhlIGZhY3QgdGhhdCB0aGUgaW50cm9kdWN0aW9uIGFycml2ZXMgdmlhIGNvbm5lY3Rpb24gYWxsb2NhdGVkIGZvciB0aGUgZ3JvdXAsIGFsbG93cyBhZ2VudHMgaWRlbnRpZnkgaXQgYXMgYSBuZXcgZ3JvdXAgbWVtYmVyLCBJRCB1c2VkIGluIGludHJvZHVjdGlvbnMgaXMgZ3JvdXAtc2NvcGVkIG1lbWJlciBJRC5cblxuICBub3RlIG92ZXIgQSwgQkE6IG9uY2UgYWxsIG1lbWJlcnMgd2VyZSBzZW50IHRvIEJcbiAgQUEgLT4-IEJBOiB2aWEgZ2lkQUI6IE1FTSBtaWRCXG5cbiAgbm90ZSBvdmVyIEJBLCBCOiBvbmNlIGFsbCBtZW1iZXJzIGFyZSBjb25uZWN0ZWRcbiAgQkEgLT4-IEI6IEc6Z2lkQiBNRU1cblxuICBub3RlIG92ZXIgQSwgQUE6IG9uY2UgYWxsIG1lbWJlcnMgcmVwb3J0ZWQgY29ubmVjdGlvblxuICBBQSAtPj4gQTogRzpnaWRBIE1FTSBpZEFCXG5cbiAgbm90ZSBvdmVyIE0sIEFBOiBmb3IgZWFjaCBtZW1iZXIgTVxuXG4gIEFBIC0-PiBNQTogdmlhIGdpZEFNOiBNRU0gbWlkQlxuICBNQSAtPj4gTTogZ2lkTSBNRU0gaWRNQlxuICBcbiAgbm90ZSBvdmVyIE0sIEI6IDMuIEIgc2VuZHMgbWVzc2FnZSB0byB0aGUgZ3JvdXBcblxuICBCIC0-PiBCQTogRzpnaWRCIFNFTkQgbXNnXG4gIEJBIC0-PiBBQTogdmlhIGdpZEJBOiBNU0cgbXNnXG4gIEJBIC0-PiBCOiBHOmdpZEIgU0VOVCBDOmlkQkEgaW50TXNnSURcbiAgQkEgLT4-IE1BOiB2aWEgZ2lkQk06IE1TRyBtc2dcbiAgQkEgLT4-IEI6IEc6Z2lkQiBTRU5UIEM6aWRCTSBpbnRNc2dJRFxuICBcbiAgbm90ZSBvdmVyIEJBLCBCOiBvbmNlIHNlbnQgdG8gYWxsXG4gIEJBIC0-PiBCOiBHOmdpZEIgU0VOVCBHOmdpZEIgaW50TXNnSURcblxuICBBQSAtPj4gQTogRzpnaWRBIE1TRyBDOmlkQUIgaW50TXNnSUQgbXNnZGF0YVxuICBBIC0-PiBBQTogRzpnaWRBIEFDSyBpbnRNc2dJRFxuICBBQSAtPj4gQkE6IHZpYSBnaWRBQjogUkNWRCBleHRNc2dJRCBoYXNoIHNpZ1xuICBCQSAtPj4gQjogRzpnaWRBIFJDVkQgQzppZEJBIGludE1zZ0lEIHN0YXR1czxicj4oc3RhdHVzIC0gbWVzc2FnZSBpbnRlZ3JpdHkgY2hlY2spXG5cbiAgTUEgLT4-IE06IEc6Z2lkTSBNU0cgQzppZE1CIGludE1zZ0lEIG1zZ2RhdGFcbiAgTSAtPj4gTUE6IEc6Z2lkTSBBQ0sgaW50TXNnSURcbiAgTUEgLT4-IEJBOiB2aWEgZ2lkTUI6IFJDVkQgZXh0TXNnSUQgaGFzaCBzaWdcbiAgQkEgLT4-IEI6IEc6Z2lkTSBSQ1ZEIEM6aWRCTSBpbnRNc2dJRCBzdGF0dXNcblxuICBub3RlIG92ZXIgQkEsIEI6IG9uY2UgcmVjZWl2ZWQgYnkgYWxsXG4gIEJBIC0-PiBCOiBHOmdpZE0gUkNWRCBHOmdpZE0gaW50TXNnSUQgc3RhdHVzXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRhLiBBIGxlYXZlcyBncm91cFxuXG4gIEEgLT4-IEFBOiBHOmdpZEEgTEVBVkVcbiAgQUEgLT4-IEE6IEc6Z2lkQSBPS1xuICBBQSAtPj4gQkE6IHZpYSBnaWRBQjogTEVGVFxuICBub3RlIG92ZXIgQUE6IHJlbW92ZSBnaWRBQlxuICBub3RlIG92ZXIgQkE6IHJlbW92ZSBnaWRCQVxuICBCQSAtPj4gQjogRzpnaWRCIExFRlQgaWRCQVxuXG4gIEFBIC0-PiBNQTogdmlhIGdpZEFNOiBMRUZUXG4gIG5vdGUgb3ZlciBBQTogcmVtb3ZlIGdpZEFNXG4gIG5vdGUgb3ZlciBNQTogcmVtb3ZlIGdpZE1BXG4gIE1BIC0-PiBNOiBHOmdpZE0gTEVGVCBpZE1BXG5cbiAgQUEgLT4-IEE6IEc6Z2lkQSBMRUZUXG5cbiAgbm90ZSBvdmVyIEIsIEJBOiBpZiBhbGwgbWVtYmVycyBsZWZ0XG4gIEJBIC0-PiBCOiBHOmdpZEI6IEVNUFRZXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRiLiBBIHJlbW92ZXMgQiBmcm9tIGdyb3VwXG5cbiAgQSAtPj4gQUE6IEc6Z2lkQSBSRU0gaWRBQlxuICBBQSAtPj4gQTogRzpnaWRBIE9LXG4gIEFBIC0-PiBCQTogdmlhIGdpZEFCOiBPVVRcbiAgbm90ZSBvdmVyIEJBOiByZW1vdmUgZ2lkQkEsIGFsbCBnaWRCTVxuICBCQSAtPj4gQjogRzpnaWRCIE9VVCBpZEJBXG5cbiAgbm90ZSBvdmVyIEFBOiByZW1vdmUgZ2lkQUJcbiAgQUEgLT4-IEE6IEc6Z2lkQSBPS1xuXG4gIG5vdGUgb3ZlciBNLCBCOiBiZWxvdyBzdGVwcyBoYXBwZW4gZm9yIGVhY2ggZXhpc3RpbmcgbWVtYmVyIE1cblxuICBBQSAtPj4gTUE6IHZpYSBnaWRBTTogUkVNIG1pZEJcbiAgbm90ZSBvdmVyIE1BOiByZW1vdmUgZ2lkTUJcbiAgTUEgLT4-IEFBOiB2aWEgZ2lkTUE6IFJFTUQgbWlkQlxuICBNQSAtPj4gTTogRzpnaWRNIFJFTUQgaWRNQiBpZE1BPGJyPihCIHJlbW92ZWQgYnkgQSlcblxuICBub3RlIG92ZXIgQSwgQUE6IG9uY2UgYWxsIG1lbWJlcnMgcmVtb3ZlZCBCXG5cbiAgQUEgLT4-IEE6IEc6Z2lkQSBSRU1EIGlkQUI8YnI-KEIgcmVtb3ZlZCBieSB0aGlzIGFnZW50KVxuXG4gIG5vdGUgb3ZlciBNLCBCOiA0Yy4gQSBkZWxldGVzIGdyb3VwXG4gIEEgLT4-IEFBOiBHOmdpZEEgREVMXG4gIEFBIC0-PiBBOiBHOmdpZEEgT0tcbiAgXG4gIEFBIC0-PiBCQTogdmlhIGdpZEFCOiBERUxcbiAgbm90ZSBvdmVyIEJBOiByZW1vdmUgYWxsIGdyb3VwIGNvbm5lY3Rpb25zIGFuZCBtZXNzYWdlc1xuICBCQSAtPj4gQjogRzpnaWRCIERFTEQgaWRCQTxicj4oZ3JvdXAgZGVsZXRlZCBieSBBKVxuICBCQSAtPj4gQUE6IHZpYSBnaWRCQTogREVMRFxuXG4gIEFBIC0-PiBNQTogdmlhIGdpZEFNOiBERUxcbiAgbm90ZSBvdmVyIE1BOiByZW1vdmUgYWxsIGdyb3VwIGNvbm5lY3Rpb25zIGFuZCBtZXNzYWdlc1xuICBNQSAtPj4gTTogRzpnaWRNIERFTEQgaWRNQTxicj4oZ3JvdXAgZGVsZXRlZCBieSBBKVxuICBNQSAtPj4gQUE6IHZpYSBnaWRNQTogREVMRFxuXG4gIEFBIC0-PiBBOiBnaWRBIERFTEQ8YnI-KGdyb3VwIGRlbGV0ZWQgYnkgdGhpcyBhZ2VudCAtIGFsbCBjb25maXJtZWQpXG4iLCJtZXJtYWlkIjp7fSwidXBkYXRlRWRpdG9yIjpmYWxzZX0), the source is [here](./groups/groups.mmd).

![sequence digram for group operations](https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gIHBhcnRpY2lwYW50IE0gYXMgRXhpc3Rpbmc8YnI-bWVtYmVyIChNKVxuICBwYXJ0aWNpcGFudCBNQSBhcyBFeGlzdGluZzxicj5tZW1iZXI8YnI-YWdlbnQgKE1BKVxuICBwYXJ0aWNpcGFudCBBIGFzIEFsaWNlIChBKVxuICBwYXJ0aWNpcGFudCBBQSBhcyBBbGljZSdzPGJyPmFnZW50IChBQSlcbiAgcGFydGljaXBhbnQgQkEgYXMgQm9iJ3M8YnI-YWdlbnQgKEJBKVxuICBwYXJ0aWNpcGFudCBCIGFzIEJvYiAoQilcblxuICBub3RlIG92ZXIgQSwgQUE6IDEuIGNyZWF0ZSBuZXcgZ3JvdXAgKG5vIG1lbWJlcnMpXG4gIEEgLT4-IEFBOiBHOmdpZEE_IE5FVzxicj4oZ2lkQSAtIGNvbm4gYWxpYXMgb2YgdGhpcyBncm91cCBmb3IgQSw8YnI-Y2FuIGJlIGdlbmVyYXRlZCBieSB0aGUgYWdlbnQuPGJyPkRvZXMgaXQgc2hhcmUgbmFtZXNwYWNlIHdpdGggY29ubmVjdGlvbnM_KVxuXG4gIG5vdGUgb3ZlciBBQTogY3JlYXRlIFwiaW50ZXJuYWxcIiBicm9hZGNhc3QgYXNzb2NpYXRlZCB3aXRoIHRoZSBncm91cDxicj4oQjogTkVXKVxuXG4gIEFBIC0-PiBBOiBHOmdpZEEgT0tcblxuICBub3RlIG92ZXIgQSwgQkE6IDIuIGFkZCBCb2IgdG8gZ3JvdXBcblxuICBBIC0-PiBBQTogQzppZEFCIElOVFJPIEc6Z2lkQSBnSW5mbzxicj4oaWRBQiAtIGNvbm4gYWxpYXMgQSBoYXMgZm9yIEIpXG4gIFxuICBub3RlIG92ZXIgQUE6IGdlbmVyYXRlIG5ldyByYW5kb20gSUQgZm9yIG1lbWJlciBCIChtaWRCLCB1bmlxdWUgcGVyIGdyb3VwKTxicj5pbml0aWF0ZSBcImludGVybmFsXCIgY29ubmVjdGlvbiBnaWRBQiBmb3IgQiBpbiBncm91cDxicj4oaW50ZXJuYWwgbWVhbnMgdGhhdCBpdCBpcyBub3QgdmlzaWJsZSB0byB0aGUgY2xpZW50czxicj5hbmQgY2Fubm90IGJlIHVzZWQgd2l0aCBjbGllbnQgY29tbWFuZHMpXG5cbiAgQUEgLT4-IEJBOiB2aWEgaWRBQjogR1JPVVAgbWlkQiBnaWRBQmludiBnSW5mb1xuICBCQSAtPj4gQjogQzppZEJBIFJFUSBnOmludklEIGdJbmZvPGJyPihpbnZJRCAtIHRvIHJlZmVyIHRvIGl0IGluIEFDUFQpXG4gIEIgLT4-IEJBOiBHOmdpZEI_IEFDUFQgZzppbnZJRDxicj4oY291bGQgYmUgYWxzbyBSSkNUIGludklEPylcblxuICBub3RlIG92ZXIgQkE6IGNyZWF0ZSBncm91cCBhbmQgXCJpbnRlcm5hbFwiIGJyb2FkY2FzdCBhc3NvY2lhdGVkIHdpdGggdGhlIGdyb3VwPGJyPihCOiBORVcpXG5cbiAgQkEgLT4-IEI6IEc6Z2lkQiBPS1xuXG4gIEJBIC0-PiBBQTogZXN0YWJsaXNoIGludGVybmFsIGNvbm5lY3Rpb24gZ2lkQkEgKHVzaW5nIGdpZEFCaW52KSBmb3IgQSBpbiBncm91cFxuXG4gIG5vdGUgb3ZlciBCQSwgQUE6IGFkZCBjb25uZWN0aW9ucyBnaWRCQSBhbmQgZ2lkQUIgdG8gYnJvYWRjYXN0czxicj4oQjogQUREKVxuIFxuICBBQSAtPj4gQTogRzpnaWRBIENPTiBpZEFCXG4gIEJBIC0-PiBCOiBHOmdpZEEgQ09OIGlkQkFcblxuICBub3RlIG92ZXIgTSwgQjogRm9yIGVhY2ggZXhpc3RpbmcgbWVtYmVyIE06PGJyPmNyZWF0ZSBhbmQgYWNjZXB0IGludGVybmFsIGludHJvZHVjdGlvbiBiZXR3ZWVuIGNvbm5lY3Rpb25zLCByZWxhdGVkIHRvIHRoZSBncm91cCwgdmlhIGdpZEFCL0JBL0FNL01BLCBjb25uZWN0aW9ucyBjcmVhdGVkIGFyZSBnaWRCTSBhbmQgZ2lkTUI8YnI-VGhlIGZhY3QgdGhhdCB0aGUgaW50cm9kdWN0aW9uIGFycml2ZXMgdmlhIGNvbm5lY3Rpb24gYWxsb2NhdGVkIGZvciB0aGUgZ3JvdXAsIGFsbG93cyBhZ2VudHMgaWRlbnRpZnkgaXQgYXMgYSBuZXcgZ3JvdXAgbWVtYmVyLCBJRCB1c2VkIGluIGludHJvZHVjdGlvbnMgaXMgZ3JvdXAtc2NvcGVkIG1lbWJlciBJRC5cblxuICBub3RlIG92ZXIgQSwgQkE6IG9uY2UgYWxsIG1lbWJlcnMgd2VyZSBzZW50IHRvIEJcbiAgQUEgLT4-IEJBOiB2aWEgZ2lkQUI6IE1FTSBtaWRCXG5cbiAgbm90ZSBvdmVyIEJBLCBCOiBvbmNlIGFsbCBtZW1iZXJzIGFyZSBjb25uZWN0ZWRcbiAgQkEgLT4-IEI6IEc6Z2lkQiBNRU1cblxuICBub3RlIG92ZXIgQSwgQUE6IG9uY2UgYWxsIG1lbWJlcnMgcmVwb3J0ZWQgY29ubmVjdGlvblxuICBBQSAtPj4gQTogRzpnaWRBIE1FTSBpZEFCXG5cbiAgbm90ZSBvdmVyIE0sIEFBOiBmb3IgZWFjaCBtZW1iZXIgTVxuXG4gIEFBIC0-PiBNQTogdmlhIGdpZEFNOiBNRU0gbWlkQlxuICBNQSAtPj4gTTogZ2lkTSBNRU0gaWRNQlxuICBcbiAgbm90ZSBvdmVyIE0sIEI6IDMuIEIgc2VuZHMgbWVzc2FnZSB0byB0aGUgZ3JvdXBcblxuICBCIC0-PiBCQTogRzpnaWRCIFNFTkQgbXNnXG4gIEJBIC0-PiBBQTogdmlhIGdpZEJBOiBNU0cgbXNnXG4gIEJBIC0-PiBCOiBHOmdpZEIgU0VOVCBDOmlkQkEgaW50TXNnSURcbiAgQkEgLT4-IE1BOiB2aWEgZ2lkQk06IE1TRyBtc2dcbiAgQkEgLT4-IEI6IEc6Z2lkQiBTRU5UIEM6aWRCTSBpbnRNc2dJRFxuICBcbiAgbm90ZSBvdmVyIEJBLCBCOiBvbmNlIHNlbnQgdG8gYWxsXG4gIEJBIC0-PiBCOiBHOmdpZEIgU0VOVCBHOmdpZEIgaW50TXNnSURcblxuICBBQSAtPj4gQTogRzpnaWRBIE1TRyBDOmlkQUIgaW50TXNnSUQgbXNnZGF0YVxuICBBIC0-PiBBQTogRzpnaWRBIEFDSyBpbnRNc2dJRFxuICBBQSAtPj4gQkE6IHZpYSBnaWRBQjogUkNWRCBleHRNc2dJRCBoYXNoIHNpZ1xuICBCQSAtPj4gQjogRzpnaWRBIFJDVkQgQzppZEJBIGludE1zZ0lEIHN0YXR1czxicj4oc3RhdHVzIC0gbWVzc2FnZSBpbnRlZ3JpdHkgY2hlY2spXG5cbiAgTUEgLT4-IE06IEc6Z2lkTSBNU0cgQzppZE1CIGludE1zZ0lEIG1zZ2RhdGFcbiAgTSAtPj4gTUE6IEc6Z2lkTSBBQ0sgaW50TXNnSURcbiAgTUEgLT4-IEJBOiB2aWEgZ2lkTUI6IFJDVkQgZXh0TXNnSUQgaGFzaCBzaWdcbiAgQkEgLT4-IEI6IEc6Z2lkTSBSQ1ZEIEM6aWRCTSBpbnRNc2dJRCBzdGF0dXNcblxuICBub3RlIG92ZXIgQkEsIEI6IG9uY2UgcmVjZWl2ZWQgYnkgYWxsXG4gIEJBIC0-PiBCOiBHOmdpZE0gUkNWRCBHOmdpZE0gaW50TXNnSUQgc3RhdHVzXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRhLiBBIGxlYXZlcyBncm91cFxuXG4gIEEgLT4-IEFBOiBHOmdpZEEgTEVBVkVcbiAgQUEgLT4-IEE6IEc6Z2lkQSBPS1xuICBBQSAtPj4gQkE6IHZpYSBnaWRBQjogTEVGVFxuICBub3RlIG92ZXIgQUE6IHJlbW92ZSBnaWRBQlxuICBub3RlIG92ZXIgQkE6IHJlbW92ZSBnaWRCQVxuICBCQSAtPj4gQjogRzpnaWRCIExFRlQgaWRCQVxuXG4gIEFBIC0-PiBNQTogdmlhIGdpZEFNOiBMRUZUXG4gIG5vdGUgb3ZlciBBQTogcmVtb3ZlIGdpZEFNXG4gIG5vdGUgb3ZlciBNQTogcmVtb3ZlIGdpZE1BXG4gIE1BIC0-PiBNOiBHOmdpZE0gTEVGVCBpZE1BXG5cbiAgQUEgLT4-IEE6IEc6Z2lkQSBMRUZUXG5cbiAgbm90ZSBvdmVyIEIsIEJBOiBpZiBhbGwgbWVtYmVycyBsZWZ0XG4gIEJBIC0-PiBCOiBHOmdpZEI6IEVNUFRZXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRiLiBBIHJlbW92ZXMgQiBmcm9tIGdyb3VwXG5cbiAgQSAtPj4gQUE6IEc6Z2lkQSBSRU0gaWRBQlxuICBBQSAtPj4gQTogRzpnaWRBIE9LXG4gIEFBIC0-PiBCQTogdmlhIGdpZEFCOiBPVVRcbiAgbm90ZSBvdmVyIEJBOiByZW1vdmUgZ2lkQkEsIGFsbCBnaWRCTVxuICBCQSAtPj4gQjogRzpnaWRCIE9VVCBpZEJBXG5cbiAgbm90ZSBvdmVyIEFBOiByZW1vdmUgZ2lkQUJcbiAgQUEgLT4-IEE6IEc6Z2lkQSBPS1xuXG4gIG5vdGUgb3ZlciBNLCBCOiBiZWxvdyBzdGVwcyBoYXBwZW4gZm9yIGVhY2ggZXhpc3RpbmcgbWVtYmVyIE1cblxuICBBQSAtPj4gTUE6IHZpYSBnaWRBTTogUkVNIG1pZEJcbiAgbm90ZSBvdmVyIE1BOiByZW1vdmUgZ2lkTUJcbiAgTUEgLT4-IEFBOiB2aWEgZ2lkTUE6IFJFTUQgbWlkQlxuICBNQSAtPj4gTTogRzpnaWRNIFJFTUQgaWRNQiBpZE1BPGJyPihCIHJlbW92ZWQgYnkgQSlcblxuICBub3RlIG92ZXIgQSwgQUE6IG9uY2UgYWxsIG1lbWJlcnMgcmVtb3ZlZCBCXG5cbiAgQUEgLT4-IEE6IEc6Z2lkQSBSRU1EIGlkQUI8YnI-KEIgcmVtb3ZlZCBieSB0aGlzIGFnZW50KVxuXG4gIG5vdGUgb3ZlciBNLCBCOiA0Yy4gQSBkZWxldGVzIGdyb3VwXG4gIEEgLT4-IEFBOiBHOmdpZEEgREVMXG4gIEFBIC0-PiBBOiBHOmdpZEEgT0tcbiAgXG4gIEFBIC0-PiBCQTogdmlhIGdpZEFCOiBERUxcbiAgbm90ZSBvdmVyIEJBOiByZW1vdmUgYWxsIGdyb3VwIGNvbm5lY3Rpb25zIGFuZCBtZXNzYWdlc1xuICBCQSAtPj4gQjogRzpnaWRCIERFTEQgaWRCQTxicj4oZ3JvdXAgZGVsZXRlZCBieSBBKVxuICBCQSAtPj4gQUE6IHZpYSBnaWRCQTogREVMRFxuXG4gIEFBIC0-PiBNQTogdmlhIGdpZEFNOiBERUxcbiAgbm90ZSBvdmVyIE1BOiByZW1vdmUgYWxsIGdyb3VwIGNvbm5lY3Rpb25zIGFuZCBtZXNzYWdlc1xuICBNQSAtPj4gTTogRzpnaWRNIERFTEQgaWRNQTxicj4oZ3JvdXAgZGVsZXRlZCBieSBBKVxuICBNQSAtPj4gQUE6IHZpYSBnaWRNQTogREVMRFxuXG4gIEFBIC0-PiBBOiBnaWRBIERFTEQ8YnI-KGdyb3VwIGRlbGV0ZWQgYnkgdGhpcyBhZ2VudCAtIGFsbCBjb25maXJtZWQpXG4iLCJtZXJtYWlkIjp7fSwidXBkYXRlRWRpdG9yIjpmYWxzZX0)

## Relevant external documents

[Signal group protocol](https://signal.org/blog/private-groups/)

[mpOTR](https://cypherpunks.ca/~iang/pubs/mpotr.pdf)

[Threema whitepaper](https://threema.ch/press-files/cryptography_whitepaper.pdf)
