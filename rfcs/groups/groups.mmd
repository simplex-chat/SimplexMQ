sequenceDiagram
  participant M as Existing<br>member (M)
  participant MA as Existing<br>member<br>agent (MA)
  participant A as Alice (A)
  participant AA as Alice's<br>agent (AA)
  participant BA as Bob's<br>agent (BA)
  participant B as Bob (B)

  note over A, AA: 1. create new group (no members)
  A ->> AA: gidA? GNEW gInfo<br>(gidA - conn alias of this group for A,<br>can be generated by the agent.<br>Does it share namespace with connections?)
  AA ->> A: gidA OK<br>(or GOK?)

  note over A, BA: 2. add Bob to group

  A ->> AA: gidA GADD idAB roleB<br>(idAB - conn alias A has for B,<br>roleB - owner/admin/member)
  
  note over AA: generate new random ID for member B (midB, unique per group)<br>initiate "internal" connection gidAB for B in group<br>(internal means that it is not visible to the clients<br>and cannot be used with client commands)

  AA ->> BA: via idAB: G_INV midB roleB roleA gidABinv gMeta gInfo<br>(gMeta contains number of members - TBC what else<br>should not contain date of creation or who created it)
  BA ->> B: idBA GINV invID roleB gMeta gInfo<br>(invID - to refer to it in GJOIN)
  B ->> BA: gidB? GJOIN invID<br>(could be also GREJECT invID?)
  BA ->> B: gidB OK

  BA ->> AA: establish internal connection gidBA (using gidABinv) for A in group
 
  AA ->> A: gidA GCON idAB
  BA ->> B: gidA GCON idBA

  note over M, B: below steps happen for each existing member M

  AA ->> BA: via gidBA: GM_ADD midM roleM<br>(midM - ID of member M in group, unique per group)
  
  note over BA: initiate connection idBM for direct messages and<br> internal gidBM for group messages between B and M
  
  BA ->> AA: via gidBA: GM_INV midM gidBMinv idBMinv<br>(idBMinv/gidBMinv - invitations to connect for member M)

  AA ->> MA: via gidAM: GM_NEW midB roleB gidBMinv idBMinv<br>(midAMB - how A identifies B to member M,<br>lvlAB - connection level, 0 - direct etc.)

  MA ->> BA: establish connection with idBM -> idMB
  MA ->> BA: establish internal connection with gidBM -> gidMB

  MA ->> AA: via gidMA: G_CON midB (or G_ADD_ERR)
  MA ->> M: gidM GCON idMB

  BA ->> AA: via gidBA: G_CON midM (or G_ADD_ERR)
  BA ->> B: gidB GCON idBM

  note over A, BA: once all members were sent to B
  AA ->> BA: via gidAB: GM_END

  note over BA, B: once all members are connected
  BA ->> B: gidB GJOINED

  note over A, AA: once all members reported connection
  AA ->> A: gidA GJOINED idAB

  AA ->> MA: via gidAM: G_JOINED midB
  MA ->> M: gidM GJOINED idMB
  
  note over M, B: 3. B sends message to the group

  B ->> BA: gidB GSEND msg
  BA ->> AA: via gidBA: G_MSG extMsgID<br>msg has the same format as A_MSG
  BA ->> MA: via gidBM: G_MSG msg
  BA ->> B: gidB GSENT intMsgID

  AA ->> A: gidA GMSG idAB intMsgID msgdata
  A ->> AA: GACK intMsgID
  AA ->> BA: G_RCVD extMsgID hash sig
  BA ->> B: GRCVD idBM intMsgID status<br>(status - message integrity check)

  MA ->> M: gidM GMSG idMB msg
  M ->> MA: GACK intMsgID
  MA ->> BA: G_RCVD extMsgID hash sig
  BA ->> B: GRCVD idBM intMsgID status

  note over M, B: 4a. A leaves group

  A ->> AA: gidA GLEAVE
  AA ->> A: gidA OK
  AA ->> BA: via gidAB: G_LEFT
  note over AA: remove gidAB
  note over BA: remove gidBA
  BA ->> B: gidB: GLEFT idBA

  AA ->> MA: via gidAM: G_LEFT
  note over AA: remove gidAM
  note over MA: remove gidMA
  MA ->> M: gidM: GLEFT idMA

  AA ->> A: gidA GLEFT

  note over B, BA: if all members left
  BA ->> B: gidB: GEMPTY

  note over M, B: 4b. A removes B from group

  A ->> AA: gidA GREM idAB
  AA ->> A: gidA OK
  AA ->> BA: via gidAB: G_OUT
  note over BA: remove gidBA, gidBM
  BA ->> B: gidB: GOUT idBA

  note over AA: remove gidAB
  AA ->> A: gidA OK

  note over M, B: below steps happen for each existing member M

  AA ->> MA: via gidAM: G_REM midB
  note over MA: remove gidMB
  MA ->> AA: via gidMA: G_REMD midB
  MA ->> M: gidM: GREMD idMB idMA<br>(B removed by A)

  note over A, AA: once all members removed B

  AA ->> A: gidA: GREMD idAB<br>(B removed by this agent)

  note over M, B: 4c. A deletes group
  A ->> AA: gidA GDEL
  AA ->> A: gidA OK
  
  AA ->> BA: via gidAB: G_DEL
  note over BA: remove all group connections and messages
  BA ->> B: gidB: GDELD idBA<br>(group deleted by A)
  BA ->> AA: via gidBA: G_DELD

  AA ->> MA: via gidAM: G_DEL
  note over MA: remove all group connections and messages
  MA ->> M: gidM: GDELD idMA<br>(group deleted by A)
  MA ->> AA: via gidMA: G_DELD

  AA ->> A: gidA GDELD<br>(group deleted by this agent)
