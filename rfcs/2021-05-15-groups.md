# SMP agent groups

## Problems

- device/user profile synchronisation
- group communication

Both use cases can be facilitated by message broadcast between a group of SMP agents.

## Solution: symmetric groups as part of SMP agent protocol

The proposed approach does not scale to large groups, as each agent has to broadcast the messages of their clients to all other agents in the group. While for large group it is more effective to have a server managing the list of group members, it introduces the challenges with key distribution, privacy etc.

This proposal contains the set of additional SMP agent commands and message envelopes to provide a low level abstraction for group communication.

The groups are symmetric, all agents who are members of the group have equal rights and can add and remove members and leave group.

All the information about the groups is stored only in the agents.

As these groups are intended to be small and consist of users who sufficiently trust each other, and for simplicity, the initial protocol version assumes that any group member can add and remove users, and these actions will be replicated by other agents without asking user approval up to a certain number of users, after which an approval can be asked.

## Group message integrity

Two approaches are possible:

1. Each agent on a regular interval sends to all agents the sender IDs and the digests of the last messages from all agents they communicate with.
To avoid `(n-1)*n` messages for each group integrity verification, IDs and digests from all senders can be compacted in one messages:

```
broadcast: %s"G_CHECK" SP memId1 ":" msgId1 ":" hash1 ":" status1 "," memId2 ":" msgId2 ":" hash2 ":" status2
```

A side question is that we currently do not support large agent messages; possibly we should support messages larger than SMP block size to simplify this and other scenarios, similarly to how websockets protocol does it. There might still be a limit to how large the full message can be. That probably requires re-thinking of how messages are managed and separation of message reception from the servers and message delivery to the clients, but this might be required anyway for when we start running the agent in the background.

The above approach requires a way to identify all members by all members to all members, but such tripartite IDs are generated when adding the new members to the group (e.g. `gidABM` in the sequence diagram).

There may be two situations to consider:

1) The recipient of this verification message can have the same message as the last one or they can have more messages received - both such scenarios are ok and do not necessarily receive a problem, as they just might be slightly ahead in receiving the messages. They would make the last matching message as ok, and the later would remain unknown - it does not indicate the lack of integrity of the group, although if the next integrity check without the same messages does (this needs to be clarified).
2) The recipient of this verification message can have fewer messages received. This situation can be resolved in several ways:
- try to retrieve all messages from the queue that is behind. It might work, but it may be that the sender is simply trying to send messages because the network is down.
- wait until the next integrity check and only report integrity violation if during the next integrity check they still cannot reconcile the previous integrity check. This is probably an acceptable compromise.

2. Each agent sends message receipts to sending agents - message receipts would contain a signature of the message hashes. In the agent uses the same verification key for each member of the group, as considered below, these receipts can be re-broadcasted to other agents (again, grouping them in one message to avoid `(n-1)*n` messages) as a proof that the messages were delivered.

Comparing with the first approach, there are pros and cons:
- pros:
  - the sender would only send such integrity check messages when they have send a message to all parties, thus avoiding the situation when some messages might have been not yet sent (or failed to send and they are retrying).
- cons:
  - integrity check message mush contain a signature per member, so it would be substantially larger.
  - agents must use the same verification key for all members in the group, complicating the group and connections management.

Overall the first approach seems better. It shows who received which messages and the only case where the lack of integrity would be reported if the same message is different or some messages are skipped to some recipients (i.e. they broadcast integrity violation for some of the senders).

## Agent commands and messages syntax

- command `gId? GNEW gInfo` - create group (response is `gId OK`)
- command `gId GADD cAlias role` - add existing connection to a group
- message `cAlias GINV invID role gMeta gInfo` - invitation to join the group
- command `gId? GJOIN invId` - accept invitation (response is `gId OK`)
- message `gId GCON cAlias` - 2 connections created with some group member (both for group and direct messages)
- message `gId GJOINED [cAlias]` - connection created with all group members for a given member or current client
- command `gId GSEND msg` - send message to group
- message `gId GSENT msgId` - notification that the message is sent and its internal ID, same as SENT
- message `gId GMSG cAlias msgdata` - received group message from cAlias, msgdata is the same set of parameters as in `MSG`
- command `gId GACK msgId` - acknowledge message reception by the client
- message `gId GRCVD cAlias msgId status` - message delivery notification
- command `gId GLEAVE` - leave the group
- message `gId GLEFT [cAlias]` - connection cAlias left the group
- command `gId GREM cAlias` - remove group member (response is `gId OK`, followed by `GREMD` notification)
- message `gId GREMD cAlias [cAlias]` - member removed
- message `gId GOUT cAlias` - you are removed (see question below - should it be just a sequence of GLEFT?)
- message `gId GEMPTY` - all members left the group and it is now empty
- command `gId GDEL` - delete the group (response is `gId OK`)
- message `gId GDELD [cAlias]` - group deleted
- TODO changing member roles

## Agent message envelopes syntax

- `G_INV mid role role gInv gMeta gInfo` - invitation to join the group
- `GM_ADD mid role` - shared member ID and connection level (see sequence diagram)
- `GM_INV mid gInv inv` - queueInfos to be passed to an existing member (previously referred to in G_MEM)
- `GM_NEW mid role gInv inv` - queueInfos from the new member to the existing member (sent by the agent that invited the new member)
- `G_CON mid` - confirmation about connection to a member
- `GM_END` - confirmation that there are no more members (so no more GM_ADD will be sent in this group, the number of GM_ADD can be more than what was sent in gMeta because some new members could have been added between G_INV and GM_ALL that needed to be sent. Managing race conditions needs clarification).
- `GM_FULL mid` - confirmation that member connected to all members
- `G_LEFT` - notification that member left the group
- `G_MSG msgdata` - group message, msgdata is the same as in A_MSG
- `G_RCVD msgID hash sig`
- `G_OUT` - you are removed from the group
- `G_REM mid` - remove member mid from the group
- `G_REMD mid` - confirmation that member is removed
- `G_DEL` - group is deleted
- TODO updates to member roles

## Questions

1. Message verification keys. Agents use separate server and encryption key for each connection, but there can be a value of having the same message verification key used for all members in the group. E.g., a member can validate to other group members that the message was delivered to all group members by sending signed message receipts they receive from the agent. This would mean that for each message `n*(n-1)` messages will be send, although signed receipts can be grouped to reduce this number. It can be done periodically, rather than on each message, as described [here](https://signal.org/blog/private-groups/).

2. Is there a value having a separate set of commands for groups or should we just use the same commands to perform different actions in the group context: SEND, SENT, etc.?

3. Member roles - there is currently no mechanism to protocol the consistency of what role each member has.

The [sequence digram for group operations](https://mermaid-js.github.io/mermaid-live-editor/#/view/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gIHBhcnRpY2lwYW50IE0gYXMgRXhpc3Rpbmc8YnI-bWVtYmVyIChNKVxuICBwYXJ0aWNpcGFudCBNQSBhcyBFeGlzdGluZzxicj5tZW1iZXI8YnI-YWdlbnQgKE1BKVxuICBwYXJ0aWNpcGFudCBBIGFzIEFsaWNlIChBKVxuICBwYXJ0aWNpcGFudCBBQSBhcyBBbGljZSdzPGJyPmFnZW50IChBQSlcbiAgcGFydGljaXBhbnQgQkEgYXMgQm9iJ3M8YnI-YWdlbnQgKEJBKVxuICBwYXJ0aWNpcGFudCBCIGFzIEJvYiAoQilcblxuICBub3RlIG92ZXIgQSwgQUE6IDEuIGNyZWF0ZSBuZXcgZ3JvdXAgKG5vIG1lbWJlcnMpXG4gIEEgLT4-IEFBOiBnaWRBPyBHTkVXIGdJbmZvPGJyPihnaWRBIC0gY29ubiBhbGlhcyBvZiB0aGlzIGdyb3VwIGZvciBBLDxicj5jYW4gYmUgZ2VuZXJhdGVkIGJ5IHRoZSBhZ2VudC48YnI-RG9lcyBpdCBzaGFyZSBuYW1lc3BhY2Ugd2l0aCBjb25uZWN0aW9ucz8pXG4gIEFBIC0-PiBBOiBnaWRBIE9LPGJyPihvciBHT0s_KVxuXG4gIG5vdGUgb3ZlciBBLCBCQTogMi4gYWRkIEJvYiB0byBncm91cFxuXG4gIEEgLT4-IEFBOiBnaWRBIEdBREQgaWRBQiByb2xlQjxicj4oaWRBQiAtIGNvbm4gYWxpYXMgQSBoYXMgZm9yIEIsPGJyPnJvbGVCIC0gb3duZXIvYWRtaW4vbWVtYmVyKVxuICBcbiAgbm90ZSBvdmVyIEFBOiBnZW5lcmF0ZSBuZXcgcmFuZG9tIElEIGZvciBtZW1iZXIgQiAobWlkQiwgdW5pcXVlIHBlciBncm91cCk8YnI-aW5pdGlhdGUgXCJpbnRlcm5hbFwiIGNvbm5lY3Rpb24gZ2lkQUIgZm9yIEIgaW4gZ3JvdXA8YnI-KGludGVybmFsIG1lYW5zIHRoYXQgaXQgaXMgbm90IHZpc2libGUgdG8gdGhlIGNsaWVudHM8YnI-YW5kIGNhbm5vdCBiZSB1c2VkIHdpdGggY2xpZW50IGNvbW1hbmRzKVxuXG4gIEFBIC0-PiBCQTogdmlhIGlkQUI6IEdfSU5WIG1pZEIgcm9sZUIgcm9sZUEgZ2lkQUJpbnYgZ01ldGEgZ0luZm88YnI-KGdNZXRhIGNvbnRhaW5zIG51bWJlciBvZiBtZW1iZXJzIC0gVEJDIHdoYXQgZWxzZTxicj5zaG91bGQgbm90IGNvbnRhaW4gZGF0ZSBvZiBjcmVhdGlvbiBvciB3aG8gY3JlYXRlZCBpdClcbiAgQkEgLT4-IEI6IGlkQkEgR0lOViBpbnZJRCByb2xlQiBnTWV0YSBnSW5mbzxicj4oaW52SUQgLSB0byByZWZlciB0byBpdCBpbiBHSk9JTilcbiAgQiAtPj4gQkE6IGdpZEI_IEdKT0lOIGludklEPGJyPihjb3VsZCBiZSBhbHNvIEdSRUpFQ1QgaW52SUQ_KVxuICBCQSAtPj4gQjogZ2lkQiBPS1xuXG4gIEJBIC0-PiBBQTogZXN0YWJsaXNoIGludGVybmFsIGNvbm5lY3Rpb24gZ2lkQkEgKHVzaW5nIGdpZEFCaW52KSBmb3IgQSBpbiBncm91cFxuIFxuICBBQSAtPj4gQTogZ2lkQSBHQ09OIGlkQUJcbiAgQkEgLT4-IEI6IGdpZEEgR0NPTiBpZEJBXG5cbiAgbm90ZSBvdmVyIE0sIEI6IGJlbG93IHN0ZXBzIGhhcHBlbiBmb3IgZWFjaCBleGlzdGluZyBtZW1iZXIgTVxuXG4gIEFBIC0-PiBCQTogdmlhIGdpZEJBOiBHTV9BREQgbWlkTSByb2xlTTxicj4obWlkTSAtIElEIG9mIG1lbWJlciBNIGluIGdyb3VwLCB1bmlxdWUgcGVyIGdyb3VwKVxuICBcbiAgbm90ZSBvdmVyIEJBOiBpbml0aWF0ZSBjb25uZWN0aW9uIGlkQk0gZm9yIGRpcmVjdCBtZXNzYWdlcyBhbmQ8YnI-IGludGVybmFsIGdpZEJNIGZvciBncm91cCBtZXNzYWdlcyBiZXR3ZWVuIEIgYW5kIE1cbiAgXG4gIEJBIC0-PiBBQTogdmlhIGdpZEJBOiBHTV9JTlYgbWlkTSBnaWRCTWludiBpZEJNaW52PGJyPihpZEJNaW52L2dpZEJNaW52IC0gaW52aXRhdGlvbnMgdG8gY29ubmVjdCBmb3IgbWVtYmVyIE0pXG5cbiAgQUEgLT4-IE1BOiB2aWEgZ2lkQU06IEdNX05FVyBtaWRCIHJvbGVCIGdpZEJNaW52IGlkQk1pbnY8YnI-KG1pZEFNQiAtIGhvdyBBIGlkZW50aWZpZXMgQiB0byBtZW1iZXIgTSw8YnI-bHZsQUIgLSBjb25uZWN0aW9uIGxldmVsLCAwIC0gZGlyZWN0IGV0Yy4pXG5cbiAgTUEgLT4-IEJBOiBlc3RhYmxpc2ggY29ubmVjdGlvbiB3aXRoIGlkQk0gLT4gaWRNQlxuICBNQSAtPj4gQkE6IGVzdGFibGlzaCBpbnRlcm5hbCBjb25uZWN0aW9uIHdpdGggZ2lkQk0gLT4gZ2lkTUJcblxuICBNQSAtPj4gQUE6IHZpYSBnaWRNQTogR19DT04gbWlkQiAob3IgR19BRERfRVJSKVxuICBNQSAtPj4gTTogZ2lkTSBHQ09OIGlkTUJcblxuICBCQSAtPj4gQUE6IHZpYSBnaWRCQTogR19DT04gbWlkTSAob3IgR19BRERfRVJSKVxuICBCQSAtPj4gQjogZ2lkQiBHQ09OIGlkQk1cblxuICBub3RlIG92ZXIgQSwgQkE6IG9uY2UgYWxsIG1lbWJlcnMgd2VyZSBzZW50IHRvIEJcbiAgQUEgLT4-IEJBOiB2aWEgZ2lkQUI6IEdNX0VORFxuXG4gIG5vdGUgb3ZlciBCQSwgQjogb25jZSBhbGwgbWVtYmVycyBhcmUgY29ubmVjdGVkXG4gIEJBIC0-PiBCOiBnaWRCIEdKT0lORURcblxuICBub3RlIG92ZXIgQSwgQUE6IG9uY2UgYWxsIG1lbWJlcnMgcmVwb3J0ZWQgY29ubmVjdGlvblxuICBBQSAtPj4gQTogZ2lkQSBHSk9JTkVEIGlkQUJcblxuICBBQSAtPj4gTUE6IHZpYSBnaWRBTTogR01fRlVMTCBtaWRCXG4gIE1BIC0-PiBNOiBnaWRNIEdKT0lORUQgaWRNQlxuICBcbiAgbm90ZSBvdmVyIE0sIEI6IDMuIEIgc2VuZHMgbWVzc2FnZSB0byB0aGUgZ3JvdXBcblxuICBCIC0-PiBCQTogZ2lkQiBHU0VORCBtc2dcbiAgQkEgLT4-IEFBOiB2aWEgZ2lkQkE6IEdfTVNHIGV4dE1zZ0lEPGJyPm1zZyBoYXMgdGhlIHNhbWUgZm9ybWF0IGFzIEFfTVNHXG4gIEJBIC0-PiBNQTogdmlhIGdpZEJNOiBHX01TRyBtc2dcbiAgQkEgLT4-IEI6IGdpZEIgR1NFTlQgaW50TXNnSURcblxuICBBQSAtPj4gQTogZ2lkQSBHTVNHIGlkQUIgaW50TXNnSUQgbXNnZGF0YVxuICBBIC0-PiBBQTogR0FDSyBpbnRNc2dJRFxuICBBQSAtPj4gQkE6IEdfUkNWRCBleHRNc2dJRCBoYXNoIHNpZ1xuICBCQSAtPj4gQjogR1JDVkQgaWRCTSBpbnRNc2dJRCBzdGF0dXM8YnI-KHN0YXR1cyAtIG1lc3NhZ2UgaW50ZWdyaXR5IGNoZWNrKVxuXG4gIE1BIC0-PiBNOiBnaWRNIEdNU0cgaWRNQiBtc2dcbiAgTSAtPj4gTUE6IEdBQ0sgaW50TXNnSURcbiAgTUEgLT4-IEJBOiBHX1JDVkQgZXh0TXNnSUQgaGFzaCBzaWdcbiAgQkEgLT4-IEI6IEdSQ1ZEIGlkQk0gaW50TXNnSUQgc3RhdHVzXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRhLiBBIGxlYXZlcyBncm91cFxuXG4gIEEgLT4-IEFBOiBnaWRBIEdMRUFWRVxuICBBQSAtPj4gQTogZ2lkQSBPS1xuICBBQSAtPj4gQkE6IHZpYSBnaWRBQjogR19MRUZUXG4gIG5vdGUgb3ZlciBBQTogcmVtb3ZlIGdpZEFCXG4gIG5vdGUgb3ZlciBCQTogcmVtb3ZlIGdpZEJBXG4gIEJBIC0-PiBCOiBnaWRCOiBHTEVGVCBpZEJBXG5cbiAgQUEgLT4-IE1BOiB2aWEgZ2lkQU06IEdfTEVGVFxuICBub3RlIG92ZXIgQUE6IHJlbW92ZSBnaWRBTVxuICBub3RlIG92ZXIgTUE6IHJlbW92ZSBnaWRNQVxuICBNQSAtPj4gTTogZ2lkTTogR0xFRlQgaWRNQVxuXG4gIEFBIC0-PiBBOiBnaWRBIEdMRUZUXG5cbiAgbm90ZSBvdmVyIEIsIEJBOiBpZiBhbGwgbWVtYmVycyBsZWZ0XG4gIEJBIC0-PiBCOiBnaWRCOiBHRU1QVFlcblxuICBub3RlIG92ZXIgTSwgQjogNGIuIEEgcmVtb3ZlcyBCIGZyb20gZ3JvdXBcblxuICBBIC0-PiBBQTogZ2lkQSBHUkVNIGlkQUJcbiAgQUEgLT4-IEE6IGdpZEEgT0tcbiAgQUEgLT4-IEJBOiB2aWEgZ2lkQUI6IEdfT1VUXG4gIG5vdGUgb3ZlciBCQTogcmVtb3ZlIGdpZEJBLCBnaWRCTVxuICBCQSAtPj4gQjogZ2lkQjogR09VVCBpZEJBXG5cbiAgbm90ZSBvdmVyIEFBOiByZW1vdmUgZ2lkQUJcbiAgQUEgLT4-IEE6IGdpZEEgT0tcblxuICBub3RlIG92ZXIgTSwgQjogYmVsb3cgc3RlcHMgaGFwcGVuIGZvciBlYWNoIGV4aXN0aW5nIG1lbWJlciBNXG5cbiAgQUEgLT4-IE1BOiB2aWEgZ2lkQU06IEdfUkVNIG1pZEJcbiAgbm90ZSBvdmVyIE1BOiByZW1vdmUgZ2lkTUJcbiAgTUEgLT4-IEFBOiB2aWEgZ2lkTUE6IEdfUkVNRCBtaWRCXG4gIE1BIC0-PiBNOiBnaWRNOiBHUkVNRCBpZE1CIGlkTUE8YnI-KEIgcmVtb3ZlZCBieSBBKVxuXG4gIG5vdGUgb3ZlciBBLCBBQTogb25jZSBhbGwgbWVtYmVycyByZW1vdmVkIEJcblxuICBBQSAtPj4gQTogZ2lkQTogR1JFTUQgaWRBQjxicj4oQiByZW1vdmVkIGJ5IHRoaXMgYWdlbnQpXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRjLiBBIGRlbGV0ZXMgZ3JvdXBcbiAgQSAtPj4gQUE6IGdpZEEgR0RFTFxuICBBQSAtPj4gQTogZ2lkQSBPS1xuICBcbiAgQUEgLT4-IEJBOiB2aWEgZ2lkQUI6IEdfREVMXG4gIG5vdGUgb3ZlciBCQTogcmVtb3ZlIGFsbCBncm91cCBjb25uZWN0aW9ucyBhbmQgbWVzc2FnZXNcbiAgQkEgLT4-IEI6IGdpZEI6IEdERUxEIGlkQkE8YnI-KGdyb3VwIGRlbGV0ZWQgYnkgQSlcbiAgQkEgLT4-IEFBOiB2aWEgZ2lkQkE6IEdfREVMRFxuXG4gIEFBIC0-PiBNQTogdmlhIGdpZEFNOiBHX0RFTFxuICBub3RlIG92ZXIgTUE6IHJlbW92ZSBhbGwgZ3JvdXAgY29ubmVjdGlvbnMgYW5kIG1lc3NhZ2VzXG4gIE1BIC0-PiBNOiBnaWRNOiBHREVMRCBpZE1BPGJyPihncm91cCBkZWxldGVkIGJ5IEEpXG4gIE1BIC0-PiBBQTogdmlhIGdpZE1BOiBHX0RFTERcblxuICBBQSAtPj4gQTogZ2lkQSBHREVMRDxicj4oZ3JvdXAgZGVsZXRlZCBieSB0aGlzIGFnZW50KVxuIiwibWVybWFpZCI6e30sInVwZGF0ZUVkaXRvciI6ZmFsc2V9), the source is [here](./groups/groups.mmd).

![sequence digram for group operations](https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gIHBhcnRpY2lwYW50IE0gYXMgRXhpc3Rpbmc8YnI-bWVtYmVyIChNKVxuICBwYXJ0aWNpcGFudCBNQSBhcyBFeGlzdGluZzxicj5tZW1iZXI8YnI-YWdlbnQgKE1BKVxuICBwYXJ0aWNpcGFudCBBIGFzIEFsaWNlIChBKVxuICBwYXJ0aWNpcGFudCBBQSBhcyBBbGljZSdzPGJyPmFnZW50IChBQSlcbiAgcGFydGljaXBhbnQgQkEgYXMgQm9iJ3M8YnI-YWdlbnQgKEJBKVxuICBwYXJ0aWNpcGFudCBCIGFzIEJvYiAoQilcblxuICBub3RlIG92ZXIgQSwgQUE6IDEuIGNyZWF0ZSBuZXcgZ3JvdXAgKG5vIG1lbWJlcnMpXG4gIEEgLT4-IEFBOiBnaWRBPyBHTkVXIGdJbmZvPGJyPihnaWRBIC0gY29ubiBhbGlhcyBvZiB0aGlzIGdyb3VwIGZvciBBLDxicj5jYW4gYmUgZ2VuZXJhdGVkIGJ5IHRoZSBhZ2VudC48YnI-RG9lcyBpdCBzaGFyZSBuYW1lc3BhY2Ugd2l0aCBjb25uZWN0aW9ucz8pXG4gIEFBIC0-PiBBOiBnaWRBIE9LPGJyPihvciBHT0s_KVxuXG4gIG5vdGUgb3ZlciBBLCBCQTogMi4gYWRkIEJvYiB0byBncm91cFxuXG4gIEEgLT4-IEFBOiBnaWRBIEdBREQgaWRBQiByb2xlQjxicj4oaWRBQiAtIGNvbm4gYWxpYXMgQSBoYXMgZm9yIEIsPGJyPnJvbGVCIC0gb3duZXIvYWRtaW4vbWVtYmVyKVxuICBcbiAgbm90ZSBvdmVyIEFBOiBnZW5lcmF0ZSBuZXcgcmFuZG9tIElEIGZvciBtZW1iZXIgQiAobWlkQiwgdW5pcXVlIHBlciBncm91cCk8YnI-aW5pdGlhdGUgXCJpbnRlcm5hbFwiIGNvbm5lY3Rpb24gZ2lkQUIgZm9yIEIgaW4gZ3JvdXA8YnI-KGludGVybmFsIG1lYW5zIHRoYXQgaXQgaXMgbm90IHZpc2libGUgdG8gdGhlIGNsaWVudHM8YnI-YW5kIGNhbm5vdCBiZSB1c2VkIHdpdGggY2xpZW50IGNvbW1hbmRzKVxuXG4gIEFBIC0-PiBCQTogdmlhIGlkQUI6IEdfSU5WIG1pZEIgcm9sZUIgcm9sZUEgZ2lkQUJpbnYgZ01ldGEgZ0luZm88YnI-KGdNZXRhIGNvbnRhaW5zIG51bWJlciBvZiBtZW1iZXJzIC0gVEJDIHdoYXQgZWxzZTxicj5zaG91bGQgbm90IGNvbnRhaW4gZGF0ZSBvZiBjcmVhdGlvbiBvciB3aG8gY3JlYXRlZCBpdClcbiAgQkEgLT4-IEI6IGlkQkEgR0lOViBpbnZJRCByb2xlQiBnTWV0YSBnSW5mbzxicj4oaW52SUQgLSB0byByZWZlciB0byBpdCBpbiBHSk9JTilcbiAgQiAtPj4gQkE6IGdpZEI_IEdKT0lOIGludklEPGJyPihjb3VsZCBiZSBhbHNvIEdSRUpFQ1QgaW52SUQ_KVxuICBCQSAtPj4gQjogZ2lkQiBPS1xuXG4gIEJBIC0-PiBBQTogZXN0YWJsaXNoIGludGVybmFsIGNvbm5lY3Rpb24gZ2lkQkEgKHVzaW5nIGdpZEFCaW52KSBmb3IgQSBpbiBncm91cFxuIFxuICBBQSAtPj4gQTogZ2lkQSBHQ09OIGlkQUJcbiAgQkEgLT4-IEI6IGdpZEEgR0NPTiBpZEJBXG5cbiAgbm90ZSBvdmVyIE0sIEI6IGJlbG93IHN0ZXBzIGhhcHBlbiBmb3IgZWFjaCBleGlzdGluZyBtZW1iZXIgTVxuXG4gIEFBIC0-PiBCQTogdmlhIGdpZEJBOiBHTV9BREQgbWlkTSByb2xlTTxicj4obWlkTSAtIElEIG9mIG1lbWJlciBNIGluIGdyb3VwLCB1bmlxdWUgcGVyIGdyb3VwKVxuICBcbiAgbm90ZSBvdmVyIEJBOiBpbml0aWF0ZSBjb25uZWN0aW9uIGlkQk0gZm9yIGRpcmVjdCBtZXNzYWdlcyBhbmQ8YnI-IGludGVybmFsIGdpZEJNIGZvciBncm91cCBtZXNzYWdlcyBiZXR3ZWVuIEIgYW5kIE1cbiAgXG4gIEJBIC0-PiBBQTogdmlhIGdpZEJBOiBHTV9JTlYgbWlkTSBnaWRCTWludiBpZEJNaW52PGJyPihpZEJNaW52L2dpZEJNaW52IC0gaW52aXRhdGlvbnMgdG8gY29ubmVjdCBmb3IgbWVtYmVyIE0pXG5cbiAgQUEgLT4-IE1BOiB2aWEgZ2lkQU06IEdNX05FVyBtaWRCIHJvbGVCIGdpZEJNaW52IGlkQk1pbnY8YnI-KG1pZEFNQiAtIGhvdyBBIGlkZW50aWZpZXMgQiB0byBtZW1iZXIgTSw8YnI-bHZsQUIgLSBjb25uZWN0aW9uIGxldmVsLCAwIC0gZGlyZWN0IGV0Yy4pXG5cbiAgTUEgLT4-IEJBOiBlc3RhYmxpc2ggY29ubmVjdGlvbiB3aXRoIGlkQk0gLT4gaWRNQlxuICBNQSAtPj4gQkE6IGVzdGFibGlzaCBpbnRlcm5hbCBjb25uZWN0aW9uIHdpdGggZ2lkQk0gLT4gZ2lkTUJcblxuICBNQSAtPj4gQUE6IHZpYSBnaWRNQTogR19DT04gbWlkQiAob3IgR19BRERfRVJSKVxuICBNQSAtPj4gTTogZ2lkTSBHQ09OIGlkTUJcblxuICBCQSAtPj4gQUE6IHZpYSBnaWRCQTogR19DT04gbWlkTSAob3IgR19BRERfRVJSKVxuICBCQSAtPj4gQjogZ2lkQiBHQ09OIGlkQk1cblxuICBub3RlIG92ZXIgQSwgQkE6IG9uY2UgYWxsIG1lbWJlcnMgd2VyZSBzZW50IHRvIEJcbiAgQUEgLT4-IEJBOiB2aWEgZ2lkQUI6IEdNX0VORFxuXG4gIG5vdGUgb3ZlciBCQSwgQjogb25jZSBhbGwgbWVtYmVycyBhcmUgY29ubmVjdGVkXG4gIEJBIC0-PiBCOiBnaWRCIEdKT0lORURcblxuICBub3RlIG92ZXIgQSwgQUE6IG9uY2UgYWxsIG1lbWJlcnMgcmVwb3J0ZWQgY29ubmVjdGlvblxuICBBQSAtPj4gQTogZ2lkQSBHSk9JTkVEIGlkQUJcblxuICBBQSAtPj4gTUE6IHZpYSBnaWRBTTogR01fRlVMTCBtaWRCXG4gIE1BIC0-PiBNOiBnaWRNIEdKT0lORUQgaWRNQlxuICBcbiAgbm90ZSBvdmVyIE0sIEI6IDMuIEIgc2VuZHMgbWVzc2FnZSB0byB0aGUgZ3JvdXBcblxuICBCIC0-PiBCQTogZ2lkQiBHU0VORCBtc2dcbiAgQkEgLT4-IEFBOiB2aWEgZ2lkQkE6IEdfTVNHIGV4dE1zZ0lEPGJyPm1zZyBoYXMgdGhlIHNhbWUgZm9ybWF0IGFzIEFfTVNHXG4gIEJBIC0-PiBNQTogdmlhIGdpZEJNOiBHX01TRyBtc2dcbiAgQkEgLT4-IEI6IGdpZEIgR1NFTlQgaW50TXNnSURcblxuICBBQSAtPj4gQTogZ2lkQSBHTVNHIGlkQUIgaW50TXNnSUQgbXNnZGF0YVxuICBBIC0-PiBBQTogR0FDSyBpbnRNc2dJRFxuICBBQSAtPj4gQkE6IEdfUkNWRCBleHRNc2dJRCBoYXNoIHNpZ1xuICBCQSAtPj4gQjogR1JDVkQgaWRCTSBpbnRNc2dJRCBzdGF0dXM8YnI-KHN0YXR1cyAtIG1lc3NhZ2UgaW50ZWdyaXR5IGNoZWNrKVxuXG4gIE1BIC0-PiBNOiBnaWRNIEdNU0cgaWRNQiBtc2dcbiAgTSAtPj4gTUE6IEdBQ0sgaW50TXNnSURcbiAgTUEgLT4-IEJBOiBHX1JDVkQgZXh0TXNnSUQgaGFzaCBzaWdcbiAgQkEgLT4-IEI6IEdSQ1ZEIGlkQk0gaW50TXNnSUQgc3RhdHVzXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRhLiBBIGxlYXZlcyBncm91cFxuXG4gIEEgLT4-IEFBOiBnaWRBIEdMRUFWRVxuICBBQSAtPj4gQTogZ2lkQSBPS1xuICBBQSAtPj4gQkE6IHZpYSBnaWRBQjogR19MRUZUXG4gIG5vdGUgb3ZlciBBQTogcmVtb3ZlIGdpZEFCXG4gIG5vdGUgb3ZlciBCQTogcmVtb3ZlIGdpZEJBXG4gIEJBIC0-PiBCOiBnaWRCOiBHTEVGVCBpZEJBXG5cbiAgQUEgLT4-IE1BOiB2aWEgZ2lkQU06IEdfTEVGVFxuICBub3RlIG92ZXIgQUE6IHJlbW92ZSBnaWRBTVxuICBub3RlIG92ZXIgTUE6IHJlbW92ZSBnaWRNQVxuICBNQSAtPj4gTTogZ2lkTTogR0xFRlQgaWRNQVxuXG4gIEFBIC0-PiBBOiBnaWRBIEdMRUZUXG5cbiAgbm90ZSBvdmVyIEIsIEJBOiBpZiBhbGwgbWVtYmVycyBsZWZ0XG4gIEJBIC0-PiBCOiBnaWRCOiBHRU1QVFlcblxuICBub3RlIG92ZXIgTSwgQjogNGIuIEEgcmVtb3ZlcyBCIGZyb20gZ3JvdXBcblxuICBBIC0-PiBBQTogZ2lkQSBHUkVNIGlkQUJcbiAgQUEgLT4-IEE6IGdpZEEgT0tcbiAgQUEgLT4-IEJBOiB2aWEgZ2lkQUI6IEdfT1VUXG4gIG5vdGUgb3ZlciBCQTogcmVtb3ZlIGdpZEJBLCBnaWRCTVxuICBCQSAtPj4gQjogZ2lkQjogR09VVCBpZEJBXG5cbiAgbm90ZSBvdmVyIEFBOiByZW1vdmUgZ2lkQUJcbiAgQUEgLT4-IEE6IGdpZEEgT0tcblxuICBub3RlIG92ZXIgTSwgQjogYmVsb3cgc3RlcHMgaGFwcGVuIGZvciBlYWNoIGV4aXN0aW5nIG1lbWJlciBNXG5cbiAgQUEgLT4-IE1BOiB2aWEgZ2lkQU06IEdfUkVNIG1pZEJcbiAgbm90ZSBvdmVyIE1BOiByZW1vdmUgZ2lkTUJcbiAgTUEgLT4-IEFBOiB2aWEgZ2lkTUE6IEdfUkVNRCBtaWRCXG4gIE1BIC0-PiBNOiBnaWRNOiBHUkVNRCBpZE1CIGlkTUE8YnI-KEIgcmVtb3ZlZCBieSBBKVxuXG4gIG5vdGUgb3ZlciBBLCBBQTogb25jZSBhbGwgbWVtYmVycyByZW1vdmVkIEJcblxuICBBQSAtPj4gQTogZ2lkQTogR1JFTUQgaWRBQjxicj4oQiByZW1vdmVkIGJ5IHRoaXMgYWdlbnQpXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRjLiBBIGRlbGV0ZXMgZ3JvdXBcbiAgQSAtPj4gQUE6IGdpZEEgR0RFTFxuICBBQSAtPj4gQTogZ2lkQSBPS1xuICBcbiAgQUEgLT4-IEJBOiB2aWEgZ2lkQUI6IEdfREVMXG4gIG5vdGUgb3ZlciBCQTogcmVtb3ZlIGFsbCBncm91cCBjb25uZWN0aW9ucyBhbmQgbWVzc2FnZXNcbiAgQkEgLT4-IEI6IGdpZEI6IEdERUxEIGlkQkE8YnI-KGdyb3VwIGRlbGV0ZWQgYnkgQSlcbiAgQkEgLT4-IEFBOiB2aWEgZ2lkQkE6IEdfREVMRFxuXG4gIEFBIC0-PiBNQTogdmlhIGdpZEFNOiBHX0RFTFxuICBub3RlIG92ZXIgTUE6IHJlbW92ZSBhbGwgZ3JvdXAgY29ubmVjdGlvbnMgYW5kIG1lc3NhZ2VzXG4gIE1BIC0-PiBNOiBnaWRNOiBHREVMRCBpZE1BPGJyPihncm91cCBkZWxldGVkIGJ5IEEpXG4gIE1BIC0-PiBBQTogdmlhIGdpZE1BOiBHX0RFTERcblxuICBBQSAtPj4gQTogZ2lkQSBHREVMRDxicj4oZ3JvdXAgZGVsZXRlZCBieSB0aGlzIGFnZW50KVxuIiwibWVybWFpZCI6e30sInVwZGF0ZUVkaXRvciI6ZmFsc2V9)

## Relevant external documents

[Signal group protocol](https://signal.org/blog/private-groups/)

[mpOTR](https://cypherpunks.ca/~iang/pubs/mpotr.pdf)

[Threema whitepaper](https://threema.ch/press-files/cryptography_whitepaper.pdf)
