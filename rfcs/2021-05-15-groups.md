# SMP agent groups

## Problems

- device/user profile synchronisation
- group communication

Both use cases can be facilitated by message broadcast between a group of SMP agents.

## Solution: symmetric groups as part of SMP agent protocol

The proposed approach does not scale to large groups, as each agent has to broadcast the messages of their clients to all other agents in the group. While for large group it is more effective to have some server managing the list of group members, it introduces its own set of challenges with key distribution, privacy etc.

This proposal contains the set of additional SMP agent commands and message envelopes to provide a low level abstraction for group communication.

The groups are symmetric, all agents who are members of the group have equal rights and can add and remove members and leave group.

All the information about the groups is stored only in the agents.

## Questions

1. Should agents use the same connections to send group messages as they have for direct messages?

Same connections
- pros:
  - simpler connection management
  - fewer commands to add group members
- cons:
  - separate group identifiers required, different for each pair of members, if separate connections were used for each group they would have played this role.
  - from today's implementation point of view - it would require changes to how messages are stored, to differentiate group messages from direct messages

Separate connections per group
- pros:
  - easier to manage messages on the agent level (e.g. leaving the group allows deleting messages in one connection)
- cons:
  - connections used for groups only would probably have to be internal to the agents, with aliases in a different namespace.
  - additional connection required for the new members to send direct messages

2. How member removal should be handled - should other agents confirm with the clients or just remove member when received notification.

3. How group deletion should be handled - should other agents confirm with the clients or just delete group when received notification. Same question is relevant for the connection - atm agent does not notify another agent about connection removal.

4. Another option is to manage groups in chat protocol via different message types.

The [sequence digram when no additional connections are created](https://mermaid-js.github.io/mermaid-live-editor/#/view/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gIHBhcnRpY2lwYW50IE0gYXMgRXhpc3Rpbmc8YnI-bWVtYmVyIChNKVxuICBwYXJ0aWNpcGFudCBNQSBhcyBFeGlzdGluZzxicj5tZW1iZXI8YnI-YWdlbnQgKE1BKVxuICBwYXJ0aWNpcGFudCBBIGFzIEFsaWNlIChBKVxuICBwYXJ0aWNpcGFudCBBQSBhcyBBbGljZSdzPGJyPmFnZW50IChBQSlcbiAgcGFydGljaXBhbnQgQkEgYXMgQm9iJ3M8YnI-YWdlbnQgKEJBKVxuICBwYXJ0aWNpcGFudCBCIGFzIEJvYiAoQilcblxuICBub3RlIG92ZXIgQSwgQUE6IDEuIGNyZWF0ZSBuZXcgZ3JvdXAgKG5vIG1lbWJlcnMpXG4gIEEgLT4-IEFBOiBnaWRBPyBHTkVXIGdyb3VwSW5mbzxicj4oZ2lkQSAtIGNvbm4gYWxpYXMgb2YgdGhpcyBncm91cCBmb3IgQSlcbiAgQUEgLT4-IEE6IGdpZEEgT0tcblxuICBub3RlIG92ZXIgQSwgQkE6IDIuIGFkZCBCb2IgdG8gZ3JvdXBcbiAgQSAtPj4gQUE6IGdpZEEgR0FERCBpZEFCPGJyPihpZEFCIC0gY29ubiBhbGlhcyBBIGhhcyBmb3IgQilcbiAgXG4gIEFBIC0-PiBCQTogdmlhIGlkQUI6IEdfSU5WIGdpZEFCfF8gZ3JvdXBJbmZvPGJyPihnaWRBQnxfIC0gcGFydGlhbCBzaGFyZWQgaWRlbnRpZmllciBmb3IgZ3JvdXAgZm9yIEEgYW5kIEI8YnI-Z3JvdXBJbmZvIGNvbnRhaW5zIGN1cnJlbnQgbnVtYmVyIG9mIG1lbWJlcnMgZXRjLilcbiAgQkEgLT4-IEI6IGlkQkEgR0lOViBncm91cEluZm9cbiAgQiAtPj4gQkE6IGdpZEI_IEdKT0lOXG4gIEJBIC0-PiBCOiBnaWRCIE9LXG4gXG4gIEJBIC0-PiBBQTogdmlhIGlkQkE6IEdfSk9JTiBnaWRBQnxCQTxicj4oaWRCQSAtIGNvbm4gYWxpYXMgQiBoYXMgZm9yIEEsPGJyPmdpZEFCfEJBIC0gc2hhcmVkIGlkZW50aWZpZXIgZm9yIGdyb3VwIGZvciBBIGFuZCBCKVxuICBBQSAtPiBBOiBnaWRBIEdDT04gaWRBQlxuXG4gIG5vdGUgb3ZlciBNLCBCOiBiZWxvdyBzdGVwcyBoYXBwZW4gZm9yIGVhY2ggZXhpc3RpbmcgbWVtYmVyIE1cblxuICBBQSAtPj4gQkE6IHZpYSBpZEFCOiBHX01FTSBnaWRBQnxCQSBjbHZsQU0gbWlkQUJNfF88YnI-KG1pZEFCTXxfIC0gcGFydGlhbCBtZW1iZXIgTSBpZCBmb3IgQSBhbmQgQiw8YnI-Y2x2bEFNIC0gY29ubmVjdGlvbiBsZXZlbCwgMCAtIGRpcmVjdCBldGMuKVxuICBcbiAgbm90ZSBvdmVyIEJBOiBjcmVhdGUgY29ubmVjdGlvbiBpZEJNXG4gIFxuICBCQSAtPj4gQUE6IHZpYSBpZEJBOiBHX0lOVl9NRU0gZ2lkQUJ8QkEgbWlkQUJNfEJBTSBnaWRCTXxfIGlkQk1pbnY8YnI-KG1pZEFCTXxCQU0gLSBtZW1iZXIgTSBpZCBmb3IgQSBhbmQgQjxicj5pZEJNaW52IC0gaW52aXRhdGlvbiB0byBjb25uZWN0IGZvciBtZW1iZXIgTSlcblxuICBBQSAtPj4gTUE6IHZpYSBpZEFNOiBHX01FTV9JTlYgZ2lkQU18TUEgY2x2bEFCIG1pZEFNQnxfIGdpZEJNfF8gaWRCTWludjxicj4oZ2lkQU0gLSBob3cgQSBpZGVudGlmaWVzIHRoaXMgbWVtYmVyIHRvIE0sPGJyPm1pZEFNQiAtIGhvdyBBIGlkZW50aWZpZXMgQiB0byBtZW1iZXIgTSw8YnI-Y2x2bEFCIC0gY29ubmVjdGlvbiBsZXZlbCwgMCAtIGRpcmVjdCBldGMuKVxuXG4gIE1BIC0-PiBCQTogZXN0YWJsaXNoIGNvbm5lY3Rpb24gd2l0aCBpZEJNIC0-IGlkTUJcblxuICBNQSAtPj4gQkE6IHZpYSBpZE1COiBHX0hFTExPIGdpZEJNfE1CXG4gIE1BIC0-PiBBQTogdmlhIGlkTUE6IEdfQ09OIGdpZEFNfE1BIG1pZEFNQnxNQUIgKG9yIEdfQUREX0VSUilcbiAgTUEgLT4-IE06IGdpZE0gR0NPTiBpZE1CXG5cbiAgQkEgLT4-IE1BOiB2aWEgaWRCTTogR19IRUxMTyBnaWRCTXxNQlxuICBCQSAtPj4gQUE6IHZpYSBpZEJBOiBHX0NPTiBnaWRBQnxCQSBtaWRBQk18QkFNIChvciBHX0FERF9FUlIpXG4gIEJBIC0-PiBCOiBnaWRCIEdDT04gaWRCTVxuXG4gIG5vdGUgb3ZlciBBLCBBQTogb25jZSBhbGwgbWVtYmVycyByZXBvcnRlZCBjb25uZWN0aW9uXG4gIEFBIC0-PiBBOiBnaWRBIEdBTEwgaWRBQlxuICBBQSAtPj4gQkE6IHZpYSBpZEFCOiBHX0FMTCBnaWRBQnxCQSBtaWRBQk18QkFNXG4gIEJBIC0-PiBCOiBnaWRCIEdBTEwgaWRCTVxuICBcbiAgbm90ZSBvdmVyIE0sIEI6IDMuIEIgc2VuZHMgbWVzc2FnZSB0byB0aGUgZ3JvdXBcblxuICBCIC0-PiBCQTogZ2lkQiBHU0VORCBtc2dcblxuICBCQSAtPj4gQUE6IHZpYSBpZEJBOiBHX01TRyBnaWRBQnxCQSBtc2dcbiAgQUEgLT4-IEE6IGdpZEEgR01TRyBpZEFCIG1zZ1xuXG4gIEJBIC0-PiBNQTogdmlhIGlkQk06IEdfTVNHIGdpZEJNfE1CIG1zZ1xuICBNQSAtPj4gTTogZ2lkTSBHTVNHIGlkTUIgbXNnXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRhLiBBIGxlYXZlcyBncm91cFxuXG4gIEEgLT4-IEFBOiBnaWRBIEdMRUFWRVxuICBBQSAtPj4gQkE6IHZpYSBpZEFCOiBHX0xFRlQgZ2lkQUJ8QkFcbiAgQkEgLT4-IEI6IGdpZEI6IEdMRUZUIGlkQkFcbiAgQUEgLT4-IE1BOiB2aWEgaWRBTTogR19MRUZUIGdpZEFNfE1BXG4gIE1BIC0-PiBNOiBnaWRNOiBHTEVGVCBpZE1BXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRiLiBBIHJlbW92ZXMgQiBmcm9tIGdyb3VwXG4gIEEgLT4-IEFBOiBnaWRBIEdNREVMIGlkQUJcbiAgQUEgLT4-IEJBOiB2aWEgaWRBQjogR19MRUZUIGdpZEFCfEJBIFxuICBCQSAtPj4gQjogZ2lkQjogR0xFRlQgaWRCQVxuXG4gIG5vdGUgb3ZlciBNLCBCOiBiZWxvdyBzdGVwcyBoYXBwZW4gZm9yIGVhY2ggZXhpc3RpbmcgbWVtYmVyIE1cblxuICBBQSAtPj4gTUE6IHZpYSBpZEFNOiBHX01ERUwgZ2lkQU18TUEgbWlkQU1CfE1BQlxuICBNQSAtPj4gQUE6IHZpYSBpZE1BOiBHX01ERUxFVEVEIGdpZEFNfE1BIG1pZEFNQnxNQUJcbiAgTUEgLT4-IEJBOiB2aWEgaWRNQjogR19NREVMIGdpZEJNfE1CXG4gIE1BIC0-PiBNOiBnaWRNOiBHTURFTEVURUQgaWRNQlxuICBCQSAtPj4gQjogZ2lkQjogR01ERUxFVEVEXG5cbiAgbm90ZSBvdmVyIEIsIEJBOiBvbmNlIGFsbCBtZW1iZXJzIHJlbW92ZWQgQlxuXG4gIEJBIC0-PiBCOiBnaWRCOiBHRU1QVFlcblxuICBub3RlIG92ZXIgTSwgQjogNGMuIEEgZGVsZXRlcyBncm91cFxuICBBIC0-PiBBQTogZ2lkQSBHREVMXG4gIEFBIC0-PiBCQTogdmlhIGlkQUI6IEdfREVMIGdpZEFCfEJBXG4gIEJBIC0-PiBCOiBnaWRCOiBHREVMRVRFRCBpZEJBXG4gIEFBIC0-PiBNQTogdmlhIGlkQU06IEdfREVMIGdpZEFNfE1BXG4gIE1BIC0-PiBNOiBnaWRNOiBHREVMRVRFRCBpZE1BXG4iLCJtZXJtYWlkIjp7fSwidXBkYXRlRWRpdG9yIjpmYWxzZX0), the source is in ./groups/groups1.mmd

The [sequence digram with additional connections](https://mermaid-js.github.io/mermaid-live-editor/#/view/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gIHBhcnRpY2lwYW50IE0gYXMgRXhpc3Rpbmc8YnI-bWVtYmVyIChNKVxuICBwYXJ0aWNpcGFudCBNQSBhcyBFeGlzdGluZzxicj5tZW1iZXI8YnI-YWdlbnQgKE1BKVxuICBwYXJ0aWNpcGFudCBBIGFzIEFsaWNlIChBKVxuICBwYXJ0aWNpcGFudCBBQSBhcyBBbGljZSdzPGJyPmFnZW50IChBQSlcbiAgcGFydGljaXBhbnQgQkEgYXMgQm9iJ3M8YnI-YWdlbnQgKEJBKVxuICBwYXJ0aWNpcGFudCBCIGFzIEJvYiAoQilcblxuICBub3RlIG92ZXIgQSwgQUE6IDEuIGNyZWF0ZSBuZXcgZ3JvdXAgKG5vIG1lbWJlcnMpXG4gIEEgLT4-IEFBOiBnaWRBPyBHTkVXIGdyb3VwSW5mbzxicj4oZ2lkQSAtIGNvbm4gYWxpYXMgb2YgdGhpcyBncm91cCBmb3IgQSlcbiAgQUEgLT4-IEE6IGdpZEEgT0tcblxuICBub3RlIG92ZXIgQSwgQkE6IDIuIGFkZCBCb2IgdG8gZ3JvdXBcbiAgQSAtPj4gQUE6IGdpZEEgR0FERCBpZEFCPGJyPihpZEFCIC0gY29ubiBhbGlhcyBBIGhhcyBmb3IgQilcbiAgXG4gIG5vdGUgb3ZlciBBQTogY3JlYXRlIGNvbm5lY3Rpb24gZ2lkQUIgZm9yIEIgaW4gZ3JvdXBcblxuICBBQSAtPj4gQkE6IHZpYSBpZEFCOiBHX0lOViBnaWRBQmludiBncm91cEluZm9cbiAgQkEgLT4-IEI6IGlkQkEgR0lOViBncm91cEluZm9cbiAgQiAtPj4gQkE6IGdpZEI_IEdKT0lOXG4gIEJBIC0-PiBCOiBnaWRCIE9LXG5cbiAgbm90ZSBvdmVyIEFBOiBjcmVhdGUgY29ubmVjdGlvbiBnaWRCQSBmb3IgQSBpbiBncm91cFxuIFxuICBCQSAtPj4gQUE6IHZpYSBnaWRCQTogR19KT0lOXG4gIEFBIC0-IEE6IGdpZEEgR0NPTiBpZEFCXG5cbiAgbm90ZSBvdmVyIE0sIEI6IGJlbG93IHN0ZXBzIGhhcHBlbiBmb3IgZWFjaCBleGlzdGluZyBtZW1iZXIgTVxuXG4gIEFBIC0-PiBCQTogdmlhIGdpZEJBOiBHX01FTSBjbHZsQU0gbWlkQUJNfF88YnI-KG1pZEFCTXxfIC0gcGFydGlhbCBtZW1iZXIgTSBpZCBmb3IgQSBhbmQgQiw8YnI-Y2x2bEFNIC0gY29ubmVjdGlvbiBsZXZlbCwgMCAtIGRpcmVjdCBldGMuKVxuICBcbiAgbm90ZSBvdmVyIEJBOiBjcmVhdGUgY29ubmVjdGlvbiBpZEJNIGZvciBkaXJlY3QgbWVzc2FnZXMgYW5kPGJyPiBnaWRCTSBmb3IgTSBpbiBncm91cFxuICBcbiAgQkEgLT4-IEFBOiB2aWEgZ2lkQkE6IEdfSU5WX01FTSBtaWRBQk18QkFNIGdpZEJNaW52IGlkQk1pbnY8YnI-KG1pZEFCTXxCQU0gLSBtZW1iZXIgTSBpZCBmb3IgQSBhbmQgQjxicj5pZEJNaW52IC0gaW52aXRhdGlvbiB0byBjb25uZWN0IGZvciBtZW1iZXIgTSlcblxuICBBQSAtPj4gTUE6IHZpYSBnaWRBTTogR19NRU1fSU5WIGNsdmxBQiBtaWRBTUJ8XyBnaWRCTWludiBpZEJNaW52PGJyPihtaWRBTUIgLSBob3cgQSBpZGVudGlmaWVzIEIgdG8gbWVtYmVyIE0sPGJyPmNsdmxBQiAtIGNvbm5lY3Rpb24gbGV2ZWwsIDAgLSBkaXJlY3QgZXRjLilcblxuICBNQSAtPj4gQkE6IGVzdGFibGlzaCBjb25uZWN0aW9uIHdpdGggaWRCTSAtPiBpZE1CXG4gIE1BIC0-PiBCQTogZXN0YWJsaXNoIGNvbm5lY3Rpb24gd2l0aCBnaWRCTSAtPiBnaWRNQlxuXG4gIE1BIC0-PiBCQTogdmlhIGdpZE1COiBHX0hFTExPXG4gIE1BIC0-PiBBQTogdmlhIGdpZE1BOiBHX0NPTiBtaWRBTUJ8TUFCIChvciBHX0FERF9FUlIpXG4gIE1BIC0-PiBNOiBnaWRNIEdDT04gaWRNQlxuXG4gIEJBIC0-PiBNQTogdmlhIGdpZEJNOiBHX0hFTExPXG4gIEJBIC0-PiBBQTogdmlhIGdpZEJBOiBHX0NPTiBtaWRBQk18QkFNIChvciBHX0FERF9FUlIpXG4gIEJBIC0-PiBCOiBnaWRCIEdDT04gaWRCTVxuXG4gIG5vdGUgb3ZlciBBLCBBQTogb25jZSBhbGwgbWVtYmVycyByZXBvcnRlZCBjb25uZWN0aW9uXG4gIEFBIC0-PiBBOiBnaWRBIEdBTEwgaWRBQlxuICBBQSAtPj4gQkE6IHZpYSBnaWRBQjogR19BTEwgbWlkQUJNfEJBTVxuICBCQSAtPj4gQjogZ2lkQiBHQUxMIGlkQkFcbiAgXG4gIG5vdGUgb3ZlciBNLCBCOiAzLiBCIHNlbmRzIG1lc3NhZ2UgdG8gdGhlIGdyb3VwXG5cbiAgQiAtPj4gQkE6IGdpZEIgR1NFTkQgbXNnXG5cbiAgQkEgLT4-IEFBOiB2aWEgZ2lkQkE6IEdfTVNHIG1zZ1xuICBBQSAtPj4gQTogZ2lkQSBHTVNHIGlkQUIgbXNnXG5cbiAgQkEgLT4-IE1BOiB2aWEgZ2lkQk06IEdfTVNHIG1zZ1xuICBNQSAtPj4gTTogZ2lkTSBHTVNHIGlkTUIgbXNnXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRhLiBBIGxlYXZlcyBncm91cFxuXG4gIEEgLT4-IEFBOiBnaWRBIEdMRUFWRVxuICBBQSAtPj4gQkE6IHZpYSBnaWRBQjogR19MRUZUXG4gIEJBIC0-PiBCOiBnaWRCOiBHTEVGVCBpZEJBXG4gIEFBIC0-PiBNQTogdmlhIGdpZEFNOiBHX0xFRlRcbiAgTUEgLT4-IE06IGdpZE06IEdMRUZUIGlkTUFcblxuICBub3RlIG92ZXIgTSwgQjogNGIuIEEgcmVtb3ZlcyBCIGZyb20gZ3JvdXBcbiAgQSAtPj4gQUE6IGdpZEEgR01ERUwgaWRBQlxuICBBQSAtPj4gQkE6IHZpYSBnaWRBQjogR19MRUZUXG4gIEJBIC0-PiBCOiBnaWRCOiBHTEVGVCBpZEJBXG5cbiAgbm90ZSBvdmVyIE0sIEI6IGJlbG93IHN0ZXBzIGhhcHBlbiBmb3IgZWFjaCBleGlzdGluZyBtZW1iZXIgTVxuXG4gIEFBIC0-PiBNQTogdmlhIGdpZEFNOiBHX01ERUwgbWlkQU1CfE1BQlxuICBNQSAtPj4gQUE6IHZpYSBnaWRNQTogR19NREVMRVRFRCBtaWRBTUJ8TUFCXG4gIE1BIC0-PiBCQTogdmlhIGdpZE1COiBHX01ERUxcbiAgTUEgLT4-IE06IGdpZE06IEdNREVMRVRFRCBpZE1CXG4gIEJBIC0-PiBCOiBnaWRCOiBHTURFTEVURURcblxuICBub3RlIG92ZXIgQiwgQkE6IG9uY2UgYWxsIG1lbWJlcnMgcmVtb3ZlZCBCIChvciBhbGwgbGVmdClcblxuICBCQSAtPj4gQjogZ2lkQjogR0VNUFRZXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRjLiBBIGRlbGV0ZXMgZ3JvdXBcbiAgQSAtPj4gQUE6IGdpZEEgR0RFTFxuICBBQSAtPj4gQkE6IHZpYSBnaWRBQjogR19ERUxcbiAgQkEgLT4-IEI6IGdpZEI6IEdERUxFVEVEIGlkQkFcbiAgQUEgLT4-IE1BOiB2aWEgZ2lkQU06IEdfREVMXG4gIE1BIC0-PiBNOiBnaWRNOiBHREVMRVRFRCBpZE1BXG4iLCJtZXJtYWlkIjp7fSwidXBkYXRlRWRpdG9yIjpmYWxzZX0), the source is in ./groups/groups2.mmd.
