# SMP agent groups

## Problems

- device/user profile synchronisation
- group communication

Both use cases can be facilitated by message broadcast between a group of SMP agents.

## Solution: symmetric groups as part of SMP agent protocol

The proposed approach does not scale to large groups, as each agent has to broadcast the messages of their clients to all other agents in the group. While for large group it is more effective to have a server managing the list of group members, it introduces the challenges with key distribution, privacy etc.

This proposal contains the set of additional SMP agent commands and message envelopes to provide a low level abstraction for group communication.

The groups are symmetric, all agents who are members of the group have equal rights and can add and remove members and leave group.

All the information about the groups is stored only in the agents.

As these groups are intended to be small and consist of users who sufficiently trust each other, and for simplicity, the initial protocol version assumes that any group member can add and remove users, and these actions will be replicated by other agents without asking user approval up to a certain number of users, after which an approval can be asked.

## Questions

1. Message verification keys. Agents use separate server and encryption key for each connection, but there can be a value of having the same message verification key used for all members in the group. E.g., a member can validate to other group members that the message was delivered to all group members by sending signed message receipts they receive from the agent. This would mean that for each message `n*(n-1)` messages will be send, although signed receipts can be grouped to reduce this number. It can be done periodically, rather than on each message, as described [here](https://signal.org/blog/private-groups/).

2. There may be a value in designating the role of the group administrators, and make that other members would only recognise the commands to add and delete members and remove the groups from the administrator. It still means that any member can pretend to be an administrator to the new members, they can broadcast to them the messages from the original group, but they won't be able to connect them to all pre-existing members.

The [sequence digram for group operations](https://mermaid-js.github.io/mermaid-live-editor/#/view/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG4gIHBhcnRpY2lwYW50IE0gYXMgRXhpc3Rpbmc8YnI-bWVtYmVyIChNKVxuICBwYXJ0aWNpcGFudCBNQSBhcyBFeGlzdGluZzxicj5tZW1iZXI8YnI-YWdlbnQgKE1BKVxuICBwYXJ0aWNpcGFudCBBIGFzIEFsaWNlIChBKVxuICBwYXJ0aWNpcGFudCBBQSBhcyBBbGljZSdzPGJyPmFnZW50IChBQSlcbiAgcGFydGljaXBhbnQgQkEgYXMgQm9iJ3M8YnI-YWdlbnQgKEJBKVxuICBwYXJ0aWNpcGFudCBCIGFzIEJvYiAoQilcblxuICBub3RlIG92ZXIgQSwgQUE6IDEuIGNyZWF0ZSBuZXcgZ3JvdXAgKG5vIG1lbWJlcnMpXG4gIEEgLT4-IEFBOiBnaWRBPyBHTkVXIGdJbmZvPGJyPihnaWRBIC0gY29ubiBhbGlhcyBvZiB0aGlzIGdyb3VwIGZvciBBLDxicj5jYW4gYmUgZ2VuZXJhdGVkIGJ5IHRoZSBhZ2VudC48YnI-RG9lcyBpdCBzaGFyZSBuYW1lc3BhY2Ugd2l0aCBjb25uZWN0aW9ucz8pXG4gIEFBIC0-PiBBOiBnaWRBIE9LPGJyPihvciBHT0s_KVxuXG4gIG5vdGUgb3ZlciBBLCBCQTogMi4gYWRkIEJvYiB0byBncm91cFxuICBBIC0-PiBBQTogZ2lkQSBHQUREIGlkQUI8YnI-KGlkQUIgLSBjb25uIGFsaWFzIEEgaGFzIGZvciBCKVxuICBcbiAgbm90ZSBvdmVyIEFBOiBpbml0aWF0ZSBpbnRlcm5hbCBjb25uZWN0aW9uIGdpZEFCIGZvciBCIGluIGdyb3VwXG5cbiAgQUEgLT4-IEJBOiB2aWEgaWRBQjogR19JTlYgZ2lkQUJpbnYgZ01ldGEgZ0luZm88YnI-KGdNZXRhIGNvbnRhaW5zIG51bWJlciBvZiBtZW1iZXJzIC0gVEJDIHdoYXQgZWxzZTxicj5zaG91bGQgbm90IGNvbnRhaW4gZGF0ZSBvZiBjcmVhdGlvbiBvciB3aG8gY3JlYXRlZCBpdClcbiAgQkEgLT4-IEI6IGlkQkEgR0lOViBpbnZJRCBnTWV0YSBnSW5mb1xuICBCIC0-PiBCQTogZ2lkQj8gR0pPSU4gaW52SUQ8YnI-KGNvdWxkIGJlIGFsc28gR1JFSkVDVCBpbnZJRD8pXG4gIEJBIC0-PiBCOiBnaWRCIE9LXG5cbiAgQkEgLT4-IEFBOiBlc3RhYmxpc2ggaW50ZXJuYWwgY29ubmVjdGlvbiBnaWRCQSAodXNpbmcgZ2lkQUJpbnYpIGZvciBBIGluIGdyb3VwPGJyPihpbnRlcm1hbCBtZWFucyB0aGF0IGl0IGlzIG5vdCB2aXNpYmxlIHRvIHRoZSBjbGllbnRzLiBTZXBhcmF0ZSBuYW1lc3BhY2U_KVxuIFxuICBBQSAtPiBBOiBnaWRBIEdDT04gaWRBQlxuXG4gIG5vdGUgb3ZlciBNLCBCOiBiZWxvdyBzdGVwcyBoYXBwZW4gZm9yIGVhY2ggZXhpc3RpbmcgbWVtYmVyIE1cblxuICBBQSAtPj4gQkE6IHZpYSBnaWRCQTogR19NRU0gbHZsQU0gbWlkQUJNfF88YnI-KG1pZEFCTSAtIGhvdyBBIGlkZW50aWZpZXMgbWVtYmVyIE0gdG8gQiw8YnI-bHZsQU0gLSBjb25uZWN0aW9uIGxldmVsLCAwIC0gZGlyZWN0LCAxIC0gdmlhIHNtYmR5IGV0Yy4pXG4gIFxuICBub3RlIG92ZXIgQkE6IGluaXRpYXRlIGNvbm5lY3Rpb24gaWRCTSBmb3IgZGlyZWN0IG1lc3NhZ2VzIGFuZDxicj4gaW50ZXJuYWwgZ2lkQk0gZm9yIGdyb3VwIG1lc3NhZ2VzIGJldHdlZW4gQiBhbmQgTVxuICBcbiAgQkEgLT4-IEFBOiB2aWEgZ2lkQkE6IEdfSU5WX01FTSBtaWRBQk18QkFNIGlkQk1pbnYvZ2lkQk1pbnY8YnI-KG1pZEJBTSAtIGhvdyBCIGlkZW50aWZpZXMgbWVtYmVyIE0gdG8gQTxicj5pZEJNaW52L2dpZEJNaW52IC0gaW52aXRhdGlvbnMgdG8gY29ubmVjdCBmb3IgbWVtYmVyIE0pXG5cbiAgQUEgLT4-IE1BOiB2aWEgZ2lkQU06IEdfTUVNX0lOViBsdmxBQiBtaWRBTUIgaWRCTWludi9naWRCTWludjxicj4obWlkQU1CIC0gaG93IEEgaWRlbnRpZmllcyBCIHRvIG1lbWJlciBNLDxicj5sdmxBQiAtIGNvbm5lY3Rpb24gbGV2ZWwsIDAgLSBkaXJlY3QgZXRjLilcblxuICBNQSAtPj4gQkE6IGVzdGFibGlzaCBjb25uZWN0aW9uIHdpdGggaWRCTSAtPiBpZE1CXG4gIE1BIC0-PiBCQTogZXN0YWJsaXNoIGludGVybmFsIGNvbm5lY3Rpb24gd2l0aCBnaWRCTSAtPiBnaWRNQlxuXG4gIE1BIC0-PiBBQTogdmlhIGdpZE1BOiBHX0NPTiBtaWRBTUJ8TUFCIChvciBHX0FERF9FUlIpXG4gIE1BIC0-PiBNOiBnaWRNIEdDT04gaWRNQlxuXG4gIEJBIC0-PiBNQTogdmlhIGdpZEJNOiBHX0hFTExPXG4gIEJBIC0-PiBBQTogdmlhIGdpZEJBOiBHX0NPTiBtaWRBQk18QkFNIChvciBHX0FERF9FUlIpXG4gIEJBIC0-PiBCOiBnaWRCIEdDT04gaWRCTVxuXG4gIG5vdGUgb3ZlciBBLCBCQTogb25jZSBhbGwgbWVtYmVycyB3ZXJlIHNlbnQgdG8gQlxuICBBQSAtPj4gQkE6IHZpYSBnaWRBQjogR19ET05FXG4gIEJBIC0-PiBCOiBnaWRCIEdET05FXG5cbiAgbm90ZSBvdmVyIEEsIEFBOiBvbmNlIGFsbCBtZW1iZXJzIHJlcG9ydGVkIGNvbm5lY3Rpb25cbiAgQUEgLT4-IEE6IGdpZEEgR0FMTCBpZEFCXG4gIFxuICBub3RlIG92ZXIgTSwgQjogMy4gQiBzZW5kcyBtZXNzYWdlIHRvIHRoZSBncm91cFxuXG4gIEIgLT4-IEJBOiBnaWRCIEdTRU5EIG1zZ1xuICBCQSAtPj4gQUE6IHZpYSBnaWRCQTogR19NU0cgbXNnPGJyPm1zZyBoYXMgdGhlIHNhbWUgZm9ybWF0IGFzIEFfTVNHXG4gIEFBIC0-PiBBOiBnaWRBIEdNU0cgaWRBQiBtc2dcbiAgQkEgLT4-IE1BOiB2aWEgZ2lkQk06IEdfTVNHIG1zZ1xuICBNQSAtPj4gTTogZ2lkTSBHTVNHIGlkTUIgbXNnXG4gIEJBIC0-PiBCOiBnaWRCIEdTRU5UIG1zZ0lEXG5cbiAgbm90ZSBvdmVyIE0sIEI6IDRhLiBBIGxlYXZlcyBncm91cFxuXG4gIEEgLT4-IEFBOiBnaWRBIEdMRUFWRVxuICBBQSAtPj4gQkE6IHZpYSBnaWRBQjogR19MRUZUXG4gIG5vdGUgb3ZlciBBQTogcmVtb3ZlIGdpZEFCXG4gIEJBIC0-PiBCOiBnaWRCOiBHTEVGVCBpZEJBXG4gIG5vdGUgb3ZlciBCQTogcmVtb3ZlIGdpZEJBXG4gIEFBIC0-PiBNQTogdmlhIGdpZEFNOiBHX0xFRlRcbiAgbm90ZSBvdmVyIEFBOiByZW1vdmUgZ2lkQU1cbiAgTUEgLT4-IE06IGdpZE06IEdMRUZUIGlkTUFcbiAgbm90ZSBvdmVyIE1BOiByZW1vdmUgZ2lkTUFcblxuICBub3RlIG92ZXIgTSwgQjogNGIuIEEgcmVtb3ZlcyBCIGZyb20gZ3JvdXBcblxuICBBIC0-PiBBQTogZ2lkQSBHTURF), the source is in ./groups/groups.mmd.

## Relevant external documents

[Signal group protocol](https://signal.org/blog/private-groups/)

[mpOTR](https://cypherpunks.ca/~iang/pubs/mpotr.pdf)

[Threema whitepaper](https://threema.ch/press-files/cryptography_whitepaper.pdf)
