# SMP Agent: message management

The proposal is to change the way SMP agent manages the messages from the SMP servers.

Currently, it acts just as a proxy, when it does not receive any further messages from the server until the client ACKs them. The downside with this approach is that the agent can't work autonomously from the client, and the client always has to be active to retrieve the messages from the server. So while the agent offers a convenient, higher abstraction level when it comes to establishing connections, it does not offer any advantage over message management than using SMP server directly. There is a benefit to have an agent as a local, mailbox-like layer that downloads all messages for all connections and makes them available for further processing on the application layer.

There are two options to consider.

## 1. Managed agent

- Agent only maintains active subscriptions to the connections that the clients explicitly requested, only during client sessions, using SUB command.
- Agent would automatically send ACK command to SMP servers and store them to the database.
- Agent would forward messages to the client in the order of their arrival, without waiting for ACK command from the client.
- Clients can ACK messages out of order, passing message ID (an existing but currently unused parameter of ACK).
- If connection is configured to send message receipts to other party, then ACK command would trigger agent doing it. Alternative options here would be to allow clients to decide whether to send message receipts to other party for each message:
  - make either `RCVD` or `NO_RCVD` an additional optional parameter of agent `ACK` command, so that the client applications can choose to send message receipts on a case by case basis - some applications may not need it, but it gives more flexibility.
  - add additional client command like `RCVD` (currently it is intended as agent notification, so we would need some other name). This option seems more composable, but it means sending 2 commands where 1 would suffice otherwise. This option would also allow to send message receipt without sending `ACK` to agent - the use case for it could be some client applications that do not have their own persistence and relies on agent's database. In this case agent `ACK` can be renamed to `MDEL` as it does nothing else other than deleting the message from the agent's database.
  - some combination - when there are default connection level settings, but also possibility to override per-message - probably the worst option, as it would require more complex logic without much tangible benefit...
- Clients should be able to request re-sending previously delivered un-ACK-ed messages (e.g. if the processing failed in the client and the client detects missing messages via agent IDs) - the proposed command is `MGET n`, where `n` is a sequential agent-assigned message ID - same that is used in ACK command.

## 2. Autonomous agent

- Agent maintains active subscriptions to all connections that the clients created, whether there are active sessions with the clients or not.
- `SUB` command would be used to receive messages from the agent, and while it is active the agent would maintain an active TCP connection(s) with the server(s) to retrieve the messages as soon as they arrive.
- In the absence of the client connection the agent would periodically check and retrieve messages from the servers, possibly up to a quota, from all active connections. If the servers do not reply, the agent could have some retry logic with exponential back-off eventually marking connections (and/or servers) as unresponsive.
- This design allows to have a single agent running in the background with multiple client applications connecting to it. It provides better message delivery guarantees, assuming transient nature of SMP server storage.